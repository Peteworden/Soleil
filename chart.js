function setCanvas(e){e?(canvas.width=BIGWIDTH,canvas.height=BIGHEIGHT):(canvas.width=NORMALWIDTH,canvas.height=NORMALHEIGHT),ctx=canvas.getContext("2d"),null!=rgEW&&null!=rgNS&&(rgNS=rgEW*canvas.height/canvas.width)}function init(){if(os=detectOSSimply(),"iphone"==os){for(orientationPermittion=!1,i=0;i<permitBtns.length;i++)permitBtns[i].addEventListener("click",permitDeviceOrientationForSafari);window.addEventListener("deviceorientation",deviceOrientation,!0)}else"android"==os&&window.addEventListener("deviceorientationabsolute",deviceOrientation,!0)}function detectOSSimply(){let e;return e=navigator.userAgent.indexOf("iPhone")>0||navigator.userAgent.indexOf("iPad")>0||navigator.userAgent.indexOf("iPod")>0?"iphone":navigator.userAgent.indexOf("Android")>0?"android":"pc",e}function permitDeviceOrientationForSafari(){DeviceOrientationEvent.requestPermission().then(e=>{"granted"===e&&(window.addEventListener("deviceorientation",()=>{}),orientationPermittion=!0)}).catch(console.error),n}function changePicsFor360(){document.getElementById("setPicsFor360Div").style.visibility="visible"}function setPicsFor360(){let e=document.getElementById("picsFor360").value;!isNaN(e)&&1<parseFloat(e)<20?(videoHeight=360/parseFloat(e),document.getElementById("arVideo").style.height=`${Math.round(100*videoHeight/2/rgNS)}%`,document.getElementById("setPicsFor360Div").style.visibility="hidden"):alert("ほんまに？")}function linkExist(e){let t=!1;if("M"!=e[0]||isNaN(e.substr(1))){if(e.startsWith("NGC")&&!isNaN(e.substr(3))||e.startsWith("IC")&&!isNaN(e.substr(2)))for(i=0;i<NGC.length/5;i++)if(NGC[5*i]==e){t=!0;break}}else for(i=0;i<messier.length;i++)if(messier[i].name==e){t=!0;break}return t}function link(e){if(!e)return void console.error("Invalid input:",e);let t=!1;for(i=0;i<starNames.length;i++)if(starNames[i].name==e){cenRA=rahm2deg(starNames[i].ra),cenDec=decdm2deg(starNames[i].dec),t=!0;break}for(i=0;i<recs.length;i++)if(recs[i].name==e){cenRA=rahm2deg(recs[i].ra),cenDec=decdm2deg(recs[i].dec),t=!0;break}if(!t)if("M"!=e[0]||isNaN(e.substr(1))){if(e.startsWith("NGC")&&!isNaN(e.substr(3))||e.startsWith("IC")&&!isNaN(e.substr(2))){for(i=0;i<NGC.length/5;i++)if(NGC[5*i]==e){cenRA=parseFloat(NGC[5*i+1]),cenDec=parseFloat(NGC[5*i+2]);break}}else if("座"==e.slice(-1))for(i=0;i<89;i++)if(e==constellations[i].JPNname+"座"){cenRA=constellations[i].ra,cenDec=constellations[i].dec;break}}else for(i=0;i<messier.length;i++)if(messier[i].name==e){cenRA=rahm2deg(messier[i].ra),cenDec=decdm2deg(messier[i].dec);break}setUrlAndLocalStorage("RA",cenRA.toFixed(2)),setUrlAndLocalStorage("Dec",cenDec.toFixed(2)),[cenAzm,cenAlt]=RADec2Ah(cenRA,cenDec,theta),setUrlAndLocalStorage("azm",cenAzm.toFixed(2)),setUrlAndLocalStorage("alt",cenAlt.toFixed(2)),history.replaceState("","",url.href),document.getElementById("settingBtn").removeAttribute("disabled"),document.getElementById("description").style.visibility="hidden",show_main()}function toUpperCaseOrKatakana(e){return null==e&&console.log("Invalid input:",e),e.replace(/[\u3041-\u309F]|[a-z]/g,function(e){return e>="a"&&e<="z"?e.toUpperCase():e>="ぁ"&&e<="ゟ"?String.fromCharCode(e.charCodeAt(0)+96):e})}function showObjectInfo(e,t){if(!document.getElementById("objectInfoCheck").checked)return;const a=[[1,8,16,17,20,27,31,33,42,44,45,51,57,64,97,104],["かに星雲","干潟星雲","わし星雲","オメガ星雲","三裂星雲","亜鈴状星雲","アンドロメダ銀河","さんかく座銀河","オリオン大星雲","プレセペ星団","プレアデス星団","子持ち銀河","環状星雲","黒眼銀河","ふくろう星雲","ソンブレロ銀河"]];let n=null,o=Math.max(canvas.width,canvas.height);for(i=0;i<infoList.length;i++){let a=Math.sqrt(Math.pow(e-infoList[i][1],2)+Math.pow(t-infoList[i][2],2));a<o&&a<Math.min(canvas.width,canvas.height)/15&&(n=infoList[i],o=a)}if(null!=n){document.getElementById("objectInfo").style.visibility="visible",document.getElementById("objectInfoName").innerHTML=n[0];let e=!1;document.getElementById("objectInfoImage").innerHTML="";for(let t of["jpg"]){const a=new Image;if(a.onload=function(){document.getElementById("objectInfoImage").appendChild(a),e=!0},a.onerror=function(){console.log(`画像が見つかりません: ${t}`)},a.src=`https://peteworden.github.io/Soleil/chartImage/${n[0].replace(/\s+/g,"")}.${t}`,e)break}if(document.getElementById("objectInfoText").innerHTML="",JPNplanets.includes(n[0]))return trackPlanet=n[0],document.getElementById("planetTrack").style.display="inline-block",void(document.getElementById("objectInfoText").innerHTML+=`<a href="https://peteworden.github.io/Soleil/SoleilWeb.html?time=${yearTextElem.value}-${monthTextElem.value}-${dateTextElem.value}-${hourTextElem.value}-${Math.floor(minuteTextElem.value/6)}&target=${ENGplanets[JPNplanets.indexOf(n[0])].split(" ").join("").split("/").join("")}&dark=1">Soleil Webでくわしく見る</a>`);if("M"==n[0][0])messier[parseInt(n[0].slice(1))-1].description.length>0?document.getElementById("objectInfoText").innerHTML=messier[parseInt(n[0].slice(1))-1].description:document.getElementById("objectInfoText").innerHTML="no description",a[0].includes(parseInt(n[0].slice(1)))?document.getElementById("objectInfoText").innerHTML+=`<br><a href="https://ja.wikipedia.org/wiki/${a[1][a[0].indexOf(parseInt(n[0].slice(1)))]}">Wikipedia</a>`:document.getElementById("objectInfoText").innerHTML+=`<br><a href="https://ja.wikipedia.org/wiki/M${n[0].slice(1)}_(天体)">Wikipedia</a>`;else if(n[0].endsWith("座")){for(i=0;i<89;i++)if(constellations[i].JPNname+"座"==n[0]){let e=constellations[i];document.getElementById("objectInfoText").innerHTML+=`<br>ラテン語名：${e.IAUname}<br>略称：${e.abbr}<br>`}}else for(let e of recs)if(e.name==n[0])return e.description.length>0?document.getElementById("objectInfoText").innerHTML=e.description:document.getElementById("objectInfoText").innerHTML="no description",void(null==e.wiki?document.getElementById("objectInfoText").innerHTML+=`<br><a href="https://ja.wikipedia.org/wiki/${e.name}">Wikipedia</a>`:e.wiki.startsWith("http")?document.getElementById("objectInfoText").innerHTML+=`<br><a href="${e.wiki}">${e.wiki}</a>`:document.getElementById("objectInfoText").innerHTML+=`<br><a href="https://ja.wikipedia.org/wiki/${e.wiki}">Wikipedia</a>`)}}function ondtlchange(e){let t=document.getElementById("dtl").value.split("T"),a=t[0].split("-"),n=t[1].split(":");setYMDHM(a[0],parseInt(a[1]).toString(),parseInt(a[2]).toString(),parseInt(n[0]).toString(),parseFloat(n[1]).toString()),realtimeOff()}function now(){let e=new Date,[t,a,n,i,o]=[e.getFullYear(),e.getMonth()+1,e.getDate(),e.getHours(),e.getMinutes()];setYMDHM(t,a,n,i,o),showingJD=YMDHM_to_JD(t,a,n,i,o)}function setYMDHM(e,t,a,n,i){yearTextElem.value=e,monthTextElem.value=t,dateTextElem.value=a,hourTextElem.value=n,null==i?(hourTextElem.value=Math.floor(n),minuteTextElem.value=Math.round(60*(n-Math.floor(n)))):minuteTextElem.value=i}function here(){function e(e){const t=Math.round(100*e.coords.latitude)/100,a=Math.round(100*e.coords.longitude)/100;t<0?document.getElementById("NSCombo").options[1].selected=!0:document.getElementById("NSCombo").options[0].selected=!0,document.getElementById("lat").value=Math.abs(t),a<0?document.getElementById("EWCombo").options[1].selected=!0:document.getElementById("EWCombo").options[0].selected=!0,document.getElementById("lon").value=Math.abs(a)}navigator.geolocation?navigator.geolocation.getCurrentPosition(e,()=>{alert("位置情報を取得できません")}):alert("お使いのブラウザは位置情報に対応していません")}function ontouchstart(e){e.preventDefault(),1===e.touches.length&&(pinchFlag=!1,dragFlag=!1,startX=e.touches[0].pageX,startY=e.touches[0].pageY,preX=startX,preY=startY)}function ontouchmove(e){if(e.preventDefault(),1===e.touches.length){if(!pinchFlag&&(dragFlag=!0,moveX=e.touches[0].pageX,moveY=e.touches[0].pageY,distance=Math.sqrt((moveX-preX)*(moveX-preX)+(moveY-preY)*(moveY-preY)),distance>dist_detect)){if("AEP"==mode){let e=-rgEW*(preX-canvas.offsetLeft-canvas.width/2)/(canvas.width/2),t=-rgNS*(preY-canvas.offsetTop-canvas.height/2)/(canvas.height/2),[a,n]=scr2RADec(e,t),i=-rgEW*(moveX-canvas.offsetLeft-canvas.width/2)/(canvas.width/2),o=-rgNS*(moveY-canvas.offsetTop-canvas.height/2)/(canvas.height/2),[l,s]=scr2RADec(i,o);cenRA=((cenRA-l+a)%360+360)%360,cenDec=Math.min(Math.max(cenDec-s+n,-90),90),[cenAzm,cenAlt]=RADec2Ah(cenRA,cenDec,theta)}else if("EtP"==mode)cenRA=((cenRA+2*rgEW*(moveX-preX)/canvas.width)%360+360)%360,cenDec=Math.min(Math.max(-90,cenDec+2*rgNS*(moveY-preY)/canvas.height),90),[cenAzm,cenAlt]=RADec2Ah(cenRA,cenDec,theta);else if("view"==mode){let e=-rgEW*(preX-canvas.offsetLeft-canvas.width/2)/(canvas.width/2),t=-rgNS*(preY-canvas.offsetTop-canvas.height/2)/(canvas.height/2),[a,n]=SHtoAh(e,t),i=-rgEW*(moveX-canvas.offsetLeft-canvas.width/2)/(canvas.width/2),o=-rgNS*(moveY-canvas.offsetTop-canvas.height/2)/(canvas.height/2),[l,s]=SHtoAh(i,o);cenAzm=((cenAzm-l+a)%360+360)%360,cenAlt=Math.min(Math.max(cenAlt-s+n,-90),90),[cenRA,cenDec]=Ah2RADec(cenAzm,cenAlt,theta)}show_main(),preX=moveX,preY=moveY}}else{dragFlag=!1,pinchFlag=!0;let t=e.touches[0].pageX,a=e.touches[0].pageY,n=e.touches[1].pageX,i=e.touches[1].pageY;if(distance=Math.sqrt((n-t)*(n-t)+(i-a)*(i-a)),baseDistance){movedDistance=distance;let e=(t+n)/2-canvas.offsetLeft-canvas.width/2,o=(a+i)/2-canvas.offsetTop-canvas.height/2,l=movedDistance/baseDistance;if(l&&l!=1/0){if(l=canvas.width<canvas.height?Math.max(Math.min(l,rgEW/minrg),rgNS/maxrg):Math.max(Math.min(l,rgNS/minrg),rgEW/maxrg),rgNS/=l,rgEW/=l,"AEP"==mode){let t=-rgEW*e/(canvas.width/2),a=-rgNS*o/(canvas.height/2);[cenRA,cenDec]=scr2RADec(t*(1-1/l),a*(1-1/l)),[cenAzm,cenAlt]=RADec2Ah(cenRA,cenDec,theta)}else if("EtP"==mode){let t=cenRA-rgEW*e/(canvas.width/2),a=cenDec-rgNS*o/(canvas.height/2);cenRA=(t+(cenRA-t)/l)%360,cenDec=Math.min(Math.max(-90,a+(cenDec-a)/l),90),[cenAzm,cenAlt]=RADec2Ah(cenRA,cenDec,theta)}else if("view"==mode){let t=-rgEW*e/(canvas.width/2),a=-rgNS*o/(canvas.height/2);[cenAzm,cenAlt]=SHtoAh(t*(1-1/l),a*(1-1/l)),[cenRA,cenDec]=Ah2RADec(cenAzm,cenAlt,theta)}document.getElementById("arVideo").style.height=`${Math.round(100*videoHeight/2/rgNS)}%`,rgtext=`視野(左右):${(2*rgEW).toFixed(1)}°`,magLim=determinMagLim(magkey1,magkey2),zerosize=determinZerosize(),show_main(),baseDistance=distance}}else baseDistance=distance}}function ontouchend(e){dragFlag&&(setUrlAndLocalStorage("RA",cenRA.toFixed(2)),setUrlAndLocalStorage("Dec",cenDec.toFixed(2)),setUrlAndLocalStorage("azm",cenAzm.toFixed(2)),setUrlAndLocalStorage("alt",cenAlt.toFixed(2)),setUrlAndLocalStorage("area",(2*rgEW).toFixed(2)),history.replaceState("","",url.href)),"0"!=e.touches.length.toString()||pinchFlag||dragFlag&&!(dragFlag&&Math.sqrt(Math.pow(moveX-startX,2)+Math.pow(moveY-startY,2))<Math.min(canvas.width,canvas.height)/10)||showObjectInfo(preX-canvas.offsetLeft,preY-canvas.offsetTop),0===e.touches.length&&(dragFlag=!1,pinchFlag=!1),baseDistance=0}function ontouchcancel(e){dragFlag&&(setUrlAndLocalStorage("RA",cenRA.toFixed(2)),setUrlAndLocalStorage("Dec",cenDec.toFixed(2)),setUrlAndLocalStorage("azm",cenAzm.toFixed(2)),setUrlAndLocalStorage("alt",cenAlt.toFixed(2)),setUrlAndLocalStorage("area",(2*rgEW).toFixed(2)),history.replaceState("","",url.href)),baseDistance=0}function onmousedown(e){dragFlag=!1,preX=e.pageX,preY=e.pageY,canvas.addEventListener("mousemove",onmousemove)}function onmousemove(e){if(dragFlag=!0,moveX=e.pageX,moveY=e.pageY,(moveX-preX)*(moveX-preX)+(moveY-preY)*(moveY-preY)>dist_detect*dist_detect){if("AEP"==mode){let e=-rgEW*(preX-canvas.offsetLeft-canvas.width/2)/(canvas.width/2),t=-rgNS*(preY-canvas.offsetTop-canvas.height/2)/(canvas.height/2),[a,n]=scr2RADec(e,t),i=-rgEW*(moveX-canvas.offsetLeft-canvas.width/2)/(canvas.width/2),o=-rgNS*(moveY-canvas.offsetTop-canvas.height/2)/(canvas.height/2),[l,s]=scr2RADec(i,o);cenRA=((cenRA-l+a)%360+360)%360,cenDec=Math.min(Math.max(cenDec-s+n,-90),90),[cenAzm,cenAlt]=RADec2Ah(cenRA,cenDec,theta)}else if("EtP"==mode)cenRA=((cenRA+2*rgEW*(moveX-preX)/canvas.width)%360+360)%360,cenDec=Math.min(Math.max(cenDec+2*rgNS*(moveY-preY)/canvas.height,-90),90),[cenAzm,cenAlt]=RADec2Ah(cenRA,cenDec,theta);else if("view"==mode){let e=-rgEW*(preX-canvas.offsetLeft-canvas.width/2)/(canvas.width/2),t=-rgNS*(preY-canvas.offsetTop-canvas.height/2)/(canvas.height/2),[a,n]=SHtoAh(e,t),i=-rgEW*(moveX-canvas.offsetLeft-canvas.width/2)/(canvas.width/2),o=-rgNS*(moveY-canvas.offsetTop-canvas.height/2)/(canvas.height/2),[l,s]=SHtoAh(i,o);cenAzm=((cenAzm-l+a)%360+360)%360,cenAlt=Math.min(Math.max(cenAlt-s+n,-90),90),[cenRA,cenDec]=Ah2RADec(cenAzm,cenAlt,theta)}show_main(),preX=moveX,preY=moveY}}function onmouseup(e){canvas.removeEventListener("mousemove",onmousemove),dragFlag?(setUrlAndLocalStorage("RA",cenRA.toFixed(2)),setUrlAndLocalStorage("Dec",cenDec.toFixed(2)),setUrlAndLocalStorage("azm",cenAzm.toFixed(2)),setUrlAndLocalStorage("alt",cenAlt.toFixed(2)),setUrlAndLocalStorage("area",(2*rgEW).toFixed(2)),history.replaceState("","",url.href),canvas.removeEventListener("mousemove",onmousemove)):showObjectInfo(preX-canvas.offsetLeft,preY-canvas.offsetTop)}function onwheel(e){e.preventDefault();let t=e.pageX-canvas.offsetLeft-canvas.width/2,a=e.pageY-canvas.offsetTop-canvas.height/2,n=1-5e-4*e.deltaY;if(n&&n!=1/0){if(n=canvas.width<canvas.height?Math.max(Math.min(n,rgEW/minrg),rgNS/maxrg):Math.max(Math.min(n,rgNS/minrg),rgEW/maxrg),rgNS/=n,rgEW/=n,"AEP"==mode){let e=-rgEW*t/(canvas.width/2),i=-rgNS*a/(canvas.height/2);[cenRA,cenDec]=scr2RADec(e*(1-1/n),i*(1-1/n)),[cenAzm,cenAlt]=RADec2Ah(cenRA,cenDec,theta)}else if("EtP"==mode){let e=cenRA-rgEW*t/(canvas.width/2),i=cenDec-rgNS*a/(canvas.height/2);cenRA=(e+(cenRA-e)/n)%360,cenDec=Math.min(Math.max(-90,i+(cenDec-i)/n),90),[cenAzm,cenAlt]=RADec2Ah(cenRA,cenDec,theta)}else if("view"==mode){let e=-rgEW*t/(canvas.width/2),i=-rgNS*a/(canvas.height/2);[cenAzm,cenAlt]=SHtoAh(e*(1-1/n),i*(1-1/n)),[cenRA,cenDec]=Ah2RADec(cenAzm,cenAlt,theta)}document.getElementById("arVideo").style.height=`${Math.round(100*videoHeight/2/rgNS)}%`,rgtext=`視野(左右):${(2*rgEW).toFixed(1)}°`,magLim=determinMagLim(magkey1,magkey2),zerosize=determinZerosize(),show_main(),baseDistance=distance,setUrlAndLocalStorage("RA",cenRA.toFixed(2)),setUrlAndLocalStorage("Dec",cenDec.toFixed(2)),setUrlAndLocalStorage("azm",cenAzm.toFixed(2)),setUrlAndLocalStorage("alt",cenAlt.toFixed(2)),setUrlAndLocalStorage("area",(2*rgEW).toFixed(2)),history.replaceState("","",url.href)}}function show_initial(){5==xhrimpcheck&&11==defaultcheck&&(13==xhrcheck?(document.getElementById("loadingtext").style.display="none",show_main()):(canvas.addEventListener("touchstart",ontouchstart),canvas.addEventListener("touchmove",ontouchmove),canvas.addEventListener("touchend",ontouchend),canvas.addEventListener("touchcancel",ontouchcancel),canvas.addEventListener("mousedown",onmousedown),canvas.addEventListener("mouseup",onmouseup),canvas.addEventListener("wheel",onwheel),document.getElementById("settingBtn").removeAttribute("disabled"),document.getElementById("descriptionBtn").removeAttribute("disabled"),newSetting(),document.getElementById("welcomeImage").style.display="none",show_main()))}function calculation(e){let t,o,l,s,r,c,d;hourAngle(e,lon_obs);for([r,c,d]=calc(planets[Obs_num],e),[ra,dec,s]=xyz_to_RADec(-r,-c,-d),solarSystemBodies[0]={x:r,y:c,z:d,ra:ra,dec:dec,dist:s,mag:100},i=1;i<planets.length;i++){let a=planets[i];9==i?([t,o,l]=calc(Earth,e),[t,o,l,ra,dec,s,Ms,ws,lon_moon,lat_moon]=calc(Moon,e),solarSystemBodies[9]={x:t,y:o,z:l,ra:ra,dec:dec,dist:s,mag:100}):([t,o,l]=calc(a,e),[ra,dec,s]=xyz_to_RADec(t-r,o-c,l-d),solarSystemBodies[i]={x:t,y:o,z:l,ra:ra,dec:dec,dist:s,mag:100})}const m=r**2+c**2+d**2;let h,g;for(n=0;n<planets.length;n++){t=solarSystemBodies[n].x,o=solarSystemBodies[n].y,l=solarSystemBodies[n].z,s=solarSystemBodies[n].dist,h=1;let e=0;if(g=10,n!=Obs_num)if(0==n)solarSystemBodies[0].mag=-26.7;else if(1==n)h=t**2+o**2+l**2,e=0!=Obs_num?Math.acos((h+s**2-m)/(2*s*Math.sqrt(h)))*rad2deg:0,solarSystemBodies[1].mag=.06328*e-.613-.0016336*e**2+33644e-9*e**3-3.4565e-7*e**4+1.6893e-9*e**5-3.0334e-12*e**6+5*Math.log10(s*Math.sqrt(h));else if(2==n)h=t**2+o**2+l**2,e=0!=Obs_num?180*Math.acos((h+s**2-m)/(2*s*Math.sqrt(h)))/pi:0,g=e<=163.7?-4.384-.001044*e+3687e-7*e**2-2814e-9*e**3+8.938e-9*e**4+5*Math.log10(s*Math.sqrt(h)):240.44228-4.384-2.81914*e+.00839034*e**2+5*Math.log10(s*Math.sqrt(h)),solarSystemBodies[2].mag=g;else if(3==n)solarSystemBodies[3].mag=1;else if(4==n)h=t**2+o**2+l**2,e=0!=Obs_num?Math.acos((h+s**2-m)/(2*s*Math.sqrt(h)))*rad2deg:0,g=e<=50?.002267*e-1.601-1302e-7*e**2+5*Math.log10(s*Math.sqrt(h)):50<e&&e<=120?-.367-.02573*e+3445e-7*e**2+5*Math.log10(s*Math.sqrt(h)):1,solarSystemBodies[4].mag=g;else if(5==n)h=t**2+o**2+l**2,e=0!=Obs_num?Math.acos((h+s**2-m)/(2*s*Math.sqrt(h)))*rad2deg:0,g=e<=12?-9.395-37e-5*e+616e-6*e**2+5*Math.log10(s*Math.sqrt(h)):-9.395-.033-2.5*Math.log10(1-e/180*1.507-.363*(e/180)**2-.062*(e/180)**3+2.809*(e/180)**4-1.876*(e/180)**5)+5*Math.log10(s*Math.sqrt(h)),solarSystemBodies[5].mag=g;else if(6==n)h=t**2+o**2+l**2,e=0!=Obs_num?180*Math.acos((h+s**2-m)/(2*s*Math.sqrt(h)))/pi:0,g=e<=6.5?1.825*sin(15*deg2rad)-8.914+.026*e-.378*sin(15*deg2rad)+Math.exp(-2.25*e)+5*Math.log10(s*Math.sqrt(h)):6<e&&e<150?2446e-7*e-8.888+2672e-7*e**2-1505e-9*e**3+4.767e-9*e**4+5*Math.log10(s*Math.sqrt(h)):.6,solarSystemBodies[6].mag=g;else if(7==n)h=t**2+o**2+l**2,e=0!=Obs_num?180*Math.acos((h+s**2-m)/(2*s*Math.sqrt(h)))/pi:0,g=e<3.1?9617e-8*e**2-7.11+1045e-7*e**2+5*Math.log10(s*Math.sqrt(h)):5.6,solarSystemBodies[7].mag=g;else if(8==n)h=t**2+o**2+l**2,e=0!=Obs_num?Math.acos((h+s**2-m)/(2*s*Math.sqrt(h)))*rad2deg:0,g=e<133?.007944*e**3-7+9617e-8*e**2+5*Math.log10(s*Math.sqrt(h)):7.8,solarSystemBodies[8].mag=g;else if(14==planets[n].length&&100!=planets[n][13]){let e=planets[n],i=e[12],r=e[13];h=t**2+o**2+l**2,a=0!=Obs_num?Math.acos((h+s**2-m)/(2*s*Math.sqrt(h))):0;let c=Math.exp(-3.33*Math.tan(a/2)**.63),d=Math.exp(-1.87*Math.tan(a/2)**1.22);solarSystemBodies[n].mag=i-2.5*Math.log10((1-r)*c+r*d)+5*Math.log10(s*Math.sqrt(h))}else solarSystemBodies[n].mag=100;else solarSystemBodies[n].mag=0}}function calc(e,t){function a(e,t){let a=e[0],n=e[1]+e[7]*(t-a)/36525,i=e[2]+e[8]*(t-a)/36525,o=(e[3]+e[9]*(t-a)/36525)*deg2rad,l=(e[4]+e[10]*(t-a)/36525)*deg2rad,s=(e[5]+e[11]*(t-a)/36525)*deg2rad,r=e[6]*deg2rad,c=n*(cos(o)*cos(s)-sin(o)*cos(l)*sin(s)),d=n*Math.sqrt(1-i**2)*(-sin(o)*cos(s)-cos(o)*cos(l)*sin(s)),m=n*(sin(o)*cos(l)*cos(s)*cose+cos(o)*sin(s)*cose-sin(o)*sin(l)*sine),h=n*Math.sqrt(1-i**2)*(cos(o)*cos(l)*cos(s)*cose-sin(o)*sin(s)*cose-cos(o)*sin(l)*sine),g=n*(sin(o)*cos(l)*cos(s)*sine+cos(o)*sin(s)*sine+sin(o)*sin(l)*cose),u=n*Math.sqrt(1-i**2)*(cos(o)*cos(l)*cos(s)*sine-sin(o)*sin(s)*sine+cos(o)*sin(l)*cose),f=.01720209895*Math.pow(n,-1.5),p=(r+f*(t-a))%(2*pi),v=p+i*sin(p);if(Math.abs(v-p)>1e-6){let e=p+i*sin(v);for(;Math.abs(e-v)>1e-6;)v=e,e=p+i*sin(v);v=e}let y=cos(v)-i,M=sin(v),E=c*y+d*M,A=m*y+h*M,S=g*y+u*M;return[E,A,S]}function n(e,t,a){let n=e-2451543.5,i=(356.047+.9856002585*n)%360*deg2rad,o=(115.3654+13.0649929509*n)%360*deg2rad,l=(125.1228-.0529538083*n)%360*deg2rad,s=(282.9404+470935e-10*n)*deg2rad,r=(318.0634+.1643573223*n)%360*deg2rad,c=.0549,d=60.2666,m=5.1454*deg2rad,h=o+r+l-i-s,g=o+r,u=o+c*sin(o);if(Math.abs(u-o)>1e-6){let e=o+c*sin(u);for(;Math.abs(e-u)>1e-6;)u=e,e=o+c*sin(u);u=e}let f=d*(cos(u)-c),p=d*Math.sqrt(1-c**2)*sin(u),v=Math.atan2(p,f),y=Math.sqrt(f**2+p**2),M=y*(cos(l)*cos(v+r)-sin(l)*sin(v+r)*cos(m)),E=y*(sin(l)*cos(v+r)+cos(l)*sin(v+r)*cos(m)),A=y*sin(v+r)*sin(m),S=Math.atan2(E,M),x=Math.atan2(A,Math.sqrt(M**2+E**2));S+=(-1.274*sin(o-2*h)+.658*sin(2*h)-.186*sin(i)-.059*sin(2*o-2*h)-.057*sin(o-2*h+i)+.053*sin(o+2*h)+.046*sin(2*h-i)+.041*sin(o-i)-.035*sin(h)-.031*sin(o+i)-.015*sin(2*g-2*h)+.011*sin(o-4*h))*deg2rad,x+=(-.173*sin(g-2*h)-.055*sin(o-g-2*h)-.046*sin(o+g-2*h)+.033*sin(g+2*h)+.017*sin(2*o+g))*deg2rad,y+=-.58*cos(o-2*h)-.46*cos(2*h),S-=2437e-7*(e-2451545)/365.25;let b=cos(x)*cos(S)*y*6378.14/149598e3,I=(-sin(x)*sine+cos(x)*sin(S)*cose)*y*6378.14/149598e3,N=(sin(x)*cose+cos(x)*sin(S)*sine)*y*6378.14/149598e3,D=b-cos(t)*cos(a)*6378.14/149598e3,w=I-cos(t)*sin(a)*6378.14/149598e3,B=N-6378.14*sin(t)/149598e3,k=(Math.atan2(w,D)*rad2deg+360)%360,_=Math.atan2(B,Math.sqrt(D**2+w**2))*rad2deg;return y*=6378.14,[b,I,N,k,_,y,i,s,S,x]}function i(e,t){let a,n=e[0],i=e[1],o=e[3]*deg2rad,l=e[4]*deg2rad,s=e[5]*deg2rad,r=i*(cos(o)*cos(s)-sin(o)*cos(l)*sin(s)),c=2*i*(-sin(o)*cos(s)-cos(o)*cos(l)*sin(s)),d=i*(sin(o)*cos(l)*cos(s)*cose+cos(o)*sin(s)*cose-sin(o)*sin(l)*sine),m=2*i*(cos(o)*cos(l)*cos(s)*cose-sin(o)*sin(s)*cose-cos(o)*sin(l)*sine),h=i*(sin(o)*cos(l)*cos(s)*sine+cos(o)*sin(s)*sine+sin(o)*sin(l)*cose),g=2*i*(cos(o)*cos(l)*cos(s)*sine-sin(o)*sin(s)*sine+cos(o)*sin(l)*cose),u=Math.atan(54.80779386*Math.pow(i,1.5)/(t-n));a=Math.tan(u/2)>=0?Math.atan(Math.pow(Math.tan(u/2),1/3)):-Math.atan(Math.pow(-Math.tan(u/2),1/3));let f=2/Math.tan(2*a),p=r*(1-f**2)+c*f,v=d*(1-f**2)+m*f,y=h*(1-f**2)+g*f;return[p,v,y]}if(e==Sun)return[0,0,0];if(e==Moon){let e,i,o,l,s,r,c,d,m,h,[g,u,f]=a(Earth,t);return[e,i,o,l,s,r,c,d,m,h]=n(t,lat_obs,theta),[g+e,u+i,f+o,l,s,r,c,d,m,h]}{let n=e[2];return n<=.99?a(e,t):i(e,t)}}function riseSetTime(e,t,a=9){}function show_main(){function e(e,t,a,n){f(e,t,d(a),n)}function t(e,t){return parseInt(360*Math.floor(t+90)+Math.floor(e))}function a(e){return(e+540-cenRA)%360-180}function n(e,t){let n=canvas.width*(.5-a(e)/rgEW/2),i=canvas.height*(.5-(t-cenDec)/rgNS/2);return[n,i]}function o(e,t){if(e==cenRA&&t==cenDec)return[0,0];{e*=deg2rad,t*=deg2rad;let a=cenRA*deg2rad,n=cenDec*deg2rad,i=sin(n)*cos(t)*cos(e-a)-cos(n)*sin(t),o=cos(t)*sin(e-a),l=cos(n)*cos(t)*cos(e-a)+sin(n)*sin(t),s=Math.acos(l)*rad2deg,r=Math.atan2(o,i),c=s*sin(r),d=-s*cos(r);return[c,d]}}function l(e,t){let a=z-e*deg2rad;t*=deg2rad;let[n,i,o]=Ry(Rz(Ry([-cos(a)*cos(t),sin(a)*cos(t),sin(t)],pi/2-lat_obs),cenAzm*deg2rad),cenAlt*deg2rad-pi/2);if(o>=1)return[0,0];{let e=Math.acos(o)*rad2deg,t=e/Math.sqrt(n**2+i**2),a=i*t,l=-n*t;return[a,l]}}function s(e,t){e=(e-loadAzm-90)*deg2rad,t*=deg2rad;let[a,n,i]=Ry(Rx(Rz([cos(e)*cos(t),-sin(e)*cos(t),sin(t)],-dev_a),-dev_b),-dev_c);if(-i>=1)return[0,0];{let e=Math.acos(-i)*rad2deg,t=-e*a/Math.sqrt(a**2+n**2),o=e*n/Math.sqrt(a**2+n**2);return[t,o]}}function r(e,t){let a=canvas.width*(.5-e/rgEW/2),n=canvas.height*(.5-t/rgNS/2);return[a,n]}function c(e,t){let i,c,d,m,h=!1;if("AEP"==mode)[i,c]=o(e,t),Math.abs(i)<rgEW&&Math.abs(c)<rgNS&&([d,m]=r(i,c),h=!0);else if("EtP"==mode)Math.abs(a(e))<rgEW&&Math.abs(t-cenDec)<rgNS&&([d,m]=n(e,t),h=!0);else if("view"==mode)[i,c]=l(e,t,z),Math.abs(i)<rgEW&&Math.abs(c)<rgNS&&([d,m]=r(i,c),h=!0);else if(["live","ar"].includes(mode)){let[a,n]=RADec2Ah(e,t,z);[i,c]=s(a,n),Math.abs(i)<rgEW&&Math.abs(c)<rgNS&&([d,m]=r(i,c),h=!0)}return[d,m,h]}function d(e){return e>magLim?zerosize/(magLim+1):zerosize/(magLim+1)+zerosize*(1-1/(magLim+1))*Math.pow((magLim-e)/magLim,1.3)}function m(e){let t;if(darker)t=starColor;else if("nodata"==e)t=starColor;else{e=Math.max(-.4,Math.min(2,parseFloat(e)));let a=0,n=0,i=0;a=e<.4?.5+.5*(e+.4)/.8:1,n=e<0?1+e:e<.4?1:1-.75*(e-.4)/1.6,i=e<.4?1:1-(e-.4)/1.6,a=Math.round(255*a),n=Math.round(255*n),i=Math.round(255*i),t=`rgba(${a}, ${n}, ${i}, 1)`}return t}function g(e,t){let a=Array(89).fill(0);for(let n=0;n<boundary.length/5;n++){let i=boundary[5*n+2],o=boundary[5*n+4];if(Math.min(i,o)<=t&&t<Math.max(i,o)){let l=boundary[5*n+1],s=boundary[5*n+3];if(e>=(t-i)*(s-l)/(o-i)+l){let e=boundary[5*n]-1;a[e]=(a[e]+1)%2}}}let n="";for(let e=0;e<89;e++){if(1==a[e]){n=constellations[e].JPNname+"座  ";break}n=t>0?"こぐま座  ":"はちぶんぎ座  "}return n}function u(e,t,a,i,o){ctx.moveTo(...n(e+o,t)),ctx.lineTo(...n(a+o,i))}function f(e,t,a,n=starColor){ctx.fillStyle=n,ctx.beginPath(),ctx.arc(e,t,a,0,2*pi,!1),ctx.fill()}function p(e){ctx.fillStyle=starColor,ctx.beginPath();for(let t of e){let e=Help[t[0]],a=Help[t[1]+1];for(i=e;i<a;i++){let e=3*(i-1),t=Tycho[e+2];if(t>=magLim)continue;let a=Tycho[e],n=Tycho[e+1],[o,l,s]=c(a,n);s&&(ctx.moveTo(o,l),ctx.arc(o,l,d(t),0,2*pi,!1))}}ctx.fill()}function v(e){ctx.beginPath();for(let t of e){let e=Help1011[t[0]],a=Help1011[t[1]+1];for(i=e;i<a;i++){let e=3*(i-1),t=Tycho1011[e+2];if(t>=magLim)continue;let a=Tycho1011[e],n=Tycho1011[e+1];[k,_,F]=c(a,n),F&&(ctx.moveTo(k,_),ctx.arc(k,_,d(t),0,2*pi,!1))}}ctx.fill()}function y(){for(ctx.strokeStyle=objectColor,ctx.fillStyle=objectColor,i=0;i<BSCnum;i++){let e=BSCRAary[i],t=BSCDecary[i];const a=["Alp","Bet","Gam","Del","Eps","Zet","Eta","The","Iot","Kap","Lam","Mu","Nu","Xi","Omc","Pi","Rho","Sig","Tau","Ups","Phi","Chi","Psi","Ome"],n=["α","β","γ","δ","ε","ζ","η","θ","ι","κ","λ","μ","ν","ξ","ο","π","ρ","σ","τ","υ","φ","χ","ψ","ω"];if(""!=Bayers[i]){let e=n[a.indexOf(Bayers[i])];""!=BayerNums[i]&&(e+=BayerNums[i]),""!=FSs[i]&&(e+="("+FSs[i]+")")}else{FSs[i]}[k,_,F]=c(e,t),F&&M(name,k,_,0)}}function M(e,t,a,n,i=16,o="serif"){ctx.beginPath(),"Gx"==n?ctx.strokeRect(t-8,a-4,16,8):"Nb"==n||"Pl"==n||"Kt"==n?(ctx.moveTo(t,a-5),ctx.lineTo(t+5,a),ctx.lineTo(t,a+5),ctx.lineTo(t-5,a),ctx.lineTo(t,a-5)):"Gb"==n?ctx.arc(t,a,5,0,2*pi,!1):"OC"==n||"C+N"==n||"Ast"==n||"TS"==n||"DS"==n?(ctx.moveTo(t,a-6),ctx.lineTo(t-5,a+3),ctx.lineTo(t+5,a+3),ctx.lineTo(t,a-6)):0==n||(ctx.moveTo(t-4,a-4),ctx.lineTo(t+4,a+4),ctx.moveTo(t-4,a+4),ctx.lineTo(t+4,a-4)),ctx.stroke(),ctx.font=i+"px "+o,ctx.fillText(e,t+5,a-5)}function E(e,t,a=objectColor){for(ctx.strokeStyle=a,ctx.fillStyle=a,i=0;i<e.length;i++){let a=e[i].name;if(""==a)continue;let n=rahm2deg(e[i].ra),o=decdm2deg(e[i].dec);[k,_,F]=c(n,o),F&&t(i,a,k,_)}}function S(){const e=[180,90,60,40];E(starNames,function(t,a,n,i){2*Math.max(rgNS,rgEW)<=e[starNames[t].tier-1]&&M(a,n,i+15,0,fontsize=20)},textColor)}function x(){E(messier,function(e,t,a,n){M(t,a,n,messier[e].class),infoList.push([t,a,n])})}function b(){E(recs,function(e,t,a,n){M(t,a,n,recs[e].class),infoList.push([t,a,n])})}function I(){for(ctx.strokeStyle=objectColor,ctx.fillStyle=objectColor,i=0;i<NGC.length/5;i++){let e=NGC[5*i],t=parseFloat(NGC[5*i+1]),a=parseFloat(NGC[5*i+2]),n=NGC[5*i+4];[k,_,F]=c(t,a),F&&M(e,k,_,n)}}function N(){let e=solarSystemBodies[0].ra*deg2rad,t=solarSystemBodies[0].dec*deg2rad,a=solarSystemBodies[9].ra*deg2rad,n=solarSystemBodies[9].dec*deg2rad,i=Math.max(canvas.width*(.259/(solarSystemBodies[9].dist/384400))/rgEW/2,13),c=Ms+.017*sin(Ms+.017*sin(Ms))+ws,d=(1-cos(c-lon_moon)*cos(lat_moon))/2;if("AEP"==mode){let i=Math.atan2(cos(t)*sin(a-e),-sin(n)*cos(t)*cos(a-e)+cos(n)*sin(t)),l=(a-.2*cos(i)/cos(n))*rad2deg,s=(n-.2*sin(i))*rad2deg,[c,d]=o(l,s),[m,h]=r(c,d);i=Math.atan2(h-_,m-k)}else if("EtP"==mode){Math.atan2(cos(t)*sin(a-e),-sin(n)*cos(t)*cos(a-e)+cos(n)*sin(t))}else if("view"==mode){let i=Math.atan2(cos(t)*sin(a-e),-sin(n)*cos(t)*cos(a-e)+cos(n)*sin(t)),o=(a-.2*cos(i)/cos(n))*rad2deg,s=(n-.2*sin(i))*rad2deg,[c,d]=l(o,s),[m,h]=r(c,d);i=Math.atan2(h-_,m-k)}else if(["live","ar"].includes(mode)){let i=Math.atan2(cos(t)*sin(a-e),-sin(n)*cos(t)*cos(a-e)+cos(n)*sin(t)),o=(a-.2*cos(i)/cos(n))*rad2deg,l=(n-.2*sin(i))*rad2deg,[c,d]=RADec2Ah(o,l,z),[m,h]=s(c,d),[g,u]=r(m,h);i=Math.atan2(u-_,g-k)}return ctx.beginPath(),d<.5?(f(k,_,i,yellowColor),ctx.fillStyle="#333",ctx.beginPath(),ctx.arc(k,_,i,P,P+pi),ctx.ellipse(k,_,i,i*(1-2*d),P-pi,0,pi),ctx.fill()):(f(k,_,i,"#333"),ctx.fillStyle=yellowColor,ctx.beginPath(),ctx.arc(k,_,i,P-pi,P),ctx.ellipse(k,_,i,i*(2*d-1),P,0,pi),ctx.fill()),i}function D(e,t,a){let[n,o,l]=calc(planets[Obs_num],t),[s,r,d]=calc(e,t),[m,h,g]=xyz_to_RADec(s-n,r-o,d-l);if([s,r,F]=c(m,h),F&&("月"!=trackPlanet||"地球"==ObsPlanet)&&(ctx.strokeStyle="lightgreen",ctx.beginPath(),ctx.moveTo(s-3,r-3),ctx.lineTo(s+3,r+3),ctx.moveTo(s-3,r+3),ctx.lineTo(s+3,r-3),ctx.stroke(),document.getElementById("planetTrackTimeCheck").checked&&a%document.getElementById("trackTextSpan").value==0)){let e="";for(i=0;i<trackDateElem.length;i++)trackDateElem[i].checked&&(e=trackDateElem[i].value);let a=JD_to_YMDHM(t),n="";ctx.font="16px serif","ymd"==e?n=`${a[0]}/${a[1]}/${a[2]}`:"ymdh"==e?n=`${a[0]}/${a[1]}/${a[2]} ${Math.round(a[3]+a[4]/60)}時`:"ymdhi"==e?n=`${a[0]}/${a[1]}/${a[2]} ${a[3]}:${a[4]}`:"md"==e?n=`${a[1]}/${a[2]}`:"mdh"==e?n=`${a[1]}/${a[2]} ${Math.round(a[3]+a[4]/60)}時`:"mdhi"==e?n=`${a[1]}/${a[2]} ${a[3]}:${a[4]}`:"d"==e?n=`${a[2]}日`:"dh"==e?n=`${a[2]}日 ${Math.round(a[3]+a[4]/60)}時`:"dhi"==e?n=`${a[2]}日 ${a[3]}:${a[4]}`:"hi"==e&&(n=`${a[3]}:${a[4]}`),ctx.fillText(n,s+5,r-5)}}function w(){function e(e,t,a,n){if([f,p]=l(...Ah2RADec(e,t,z)),j>0&&(Math.abs(a)<rgEW&&Math.abs(n)<rgNS||Math.abs(f)<rgEW&&Math.abs(p)<rgNS)){let[e,t]=r(a,n),[i,o]=r(f,p);ctx.moveTo(e,t),ctx.lineTo(i,o)}return[a,n]=[f,p],[a,n]}let t=Math.max(-90,Math.min(SHtoAh(rgEW,-rgNS)[1],cenAlt-rgNS)),a=Math.min(90,Math.max(SHtoAh(rgEW,rgNS)[1],cenAlt+rgNS)),n=Math.min(rgEW,rgNS)/20,o=Math.min(n/Math.max(cos(cenAlt*deg2rad),.1),8),s=[.5,1,2,5,10,30,45];ctx.strokeStyle="gray";let c=45;for(i=0;i<s.length;i++)if(s[i]>Math.min(rgNS,rgEW)/3){c=s[i];break}let d=45;for(i=0;i<s.length;i++)if(s[i]>c/cos(cenAlt*deg2rad)){d=s[i];break}let m,h,g,u,f,p;if(90==a){for(i=Math.floor(t/c);i<Math.ceil(90/c);i++){for(h=i*c,ctx.lineWidth=0==h?3:1,ctx.beginPath(),j=0;j<360/o+1;j++)m=j*o,[g,u]=e(m,h,g,u);ctx.stroke()}for(ctx.lineWidth=1,i=0;i<Math.ceil(360/d);i++){for(m=i*d,j=0;j<Math.ceil(90/n)-Math.floor(t/n)+1;j++)h=(Math.floor(t/n)+j)*n,[g,u]=e(m,h,g,u);ctx.stroke()}}else if(-90==t){for(i=Math.floor(-90/c);i<Math.ceil(a/c);i++){for(h=i*c,ctx.lineWidth=0==h?3:1,ctx.beginPath(),j=0;j<360/o+1;j++)m=j*o,[g,u]=e(m,h,g,u);ctx.stroke()}for(ctx.lineWidth=1,i=0;i<Math.ceil(360/d);i++){for(m=i*d,j=0;j<Math.ceil((a+90)/n)+1;j++)h=j*n-90,[g,u]=e(m,h,g,u);ctx.stroke()}}else{let l=Math.max((SHtoAh(-rgEW,rgNS)[0]-cenAzm+360)%360,(SHtoAh(-rgEW,0)[0]-cenAzm+360)%360,(SHtoAh(-rgEW,-rgNS)[0]-cenAzm+360)%360);for(i=Math.floor(t/c);i<Math.ceil(a/c);i++){for(h=i*c,ctx.lineWidth=0==h?3:1,ctx.beginPath(),j=0;j<2*l/o+1;j++)m=cenAzm-l+j*o,[g,u]=e(m,h,g,u);ctx.stroke()}if(ctx.lineWidth=1,cenAzm-l<0){for(i=0;i<Math.ceil((cenAzm+l)/d);i++){for(m=i*d,j=0;j<Math.ceil(a/n)-Math.floor(t/n)+1;j++)h=(Math.floor(t/n)+j)*n,[g,u]=e(m,h,g,u);ctx.stroke()}for(i=Math.floor((cenAzm-l+360)/d);i<Math.ceil(360/d);i++){for(m=i*d,j=0;j<Math.ceil(a/n)-Math.floor(t/n)+1;j++)h=(Math.floor(t/n)+j)*n,[g,u]=e(m,h,g,u);ctx.stroke()}}else if(cenAzm+l>360){for(i=0;i<Math.ceil((cenAzm+l)/d);i++){for(m=i*d,j=0;j<Math.ceil(a/n)-Math.floor(t/n)+1;j++)h=(Math.floor(t/n)+j)*n,[g,u]=e(m,h,g,u);ctx.stroke()}for(i=Math.floor((cenAzm-l)/d);i<Math.ceil(360/d);i++){for(m=i*d,j=0;j<Math.ceil(a/n)-Math.floor(t/n)+1;j++)h=(Math.floor(t/n)+j)*n,[g,u]=e(m,h,g,u);ctx.stroke()}}else for(i=Math.floor((cenAzm-l)/d);i<Math.ceil((cenAzm+l)/d);i++){for(m=i*d,j=0;j<Math.ceil(a/n)-Math.floor(t/n)+1;j++)h=(Math.floor(t/n)+j)*n,[g,u]=e(m,h,g,u);ctx.stroke()}}ctx.stroke()}function B(){let e=[["85-cmos",3.34,2.27],["128-cmos",1.36,.91]];if(document.getElementById("aovCheck").checked&&["AEP","view"].includes(mode)){let t="";for(i=0;i<document.getElementsByName("aov").length;i++)document.getElementsByName("aov").item(i).checked&&(t=document.getElementsByName("aov").item(i).value);for(let a of e)if(t==a[0]){let e=aovSliderElem.value*deg2rad,t=a[1]*cos(e)+a[2]*sin(e),n=a[1]*cos(e)-a[2]*sin(e),i=-a[1]*sin(e)+a[2]*cos(e),o=-a[1]*sin(e)-a[2]*cos(e);ctx.fillStyle="rgba(255, 255, 0, 0.1)",ctx.strokeStyle="orange",ctx.beginPath(),ctx.moveTo(canvas.width*(1-t/2/rgEW)/2,canvas.height*(1-i/2/rgNS)/2),ctx.lineTo(canvas.width*(1+n/2/rgEW)/2,canvas.height*(1+o/2/rgNS)/2),ctx.lineTo(canvas.width*(1+t/2/rgEW)/2,canvas.height*(1+i/2/rgNS)/2),ctx.lineTo(canvas.width*(1-n/2/rgEW)/2,canvas.height*(1-o/2/rgNS)/2),ctx.lineTo(canvas.width*(1-t/2/rgEW)/2,canvas.height*(1-i/2/rgNS)/2),ctx.fill(),ctx.stroke()}}}let k,_,C,T,$,L,R;ctx.clearRect(0,0,canvas.width,canvas.height),ctx.fillStyle=skycolor,ctx.fillRect(0,0,canvas.width,canvas.height);let F=!1;infoList=[];let W=showingJD,z=hourAngle(W,lon_obs);["live","ar"].includes(mode)&&([cenAzm,cenAlt]=screen2liveAh(0,0)),
["AEP","EtP"].includes(mode)?[cenAzm,cenAlt]=RADec2Ah(cenRA,cenDec,z):["view","live","ar"].includes(mode)&&([cenRA,cenDec]=Ah2RADec(cenAzm,cenAlt,z));let H="",O="";if("地球"==ObsPlanet){let[e,t]=RADec2Ah(cenRA,cenDec,z);const a=["北","北北東","北東","東北東","東","東南東","南東","南南東","南","南南西","南西","西南西","西","西北西","北西","北北西","北"];let n=a[Math.floor((e+11.25)/22.5)];H=`方位角 ${e.toFixed(1)}°(${n}) `,O=`高度 ${t.toFixed(1)}° `,moving&&(O+=" wait...")}if("view"==mode&&document.getElementById("gridCheck").checked&&w(),["view","live","ar"].includes(mode)&&document.getElementById("demCheck").checked&&document.getElementById("demFileInput").files.length>0){const e=new FileReader;e.onload=function(e){const t=e.target.result.split(",").map(Number);if(66049==t.length){const e=[...Array(66049)].map(()=>Array(3).fill(0));for(obsHeight=t[33024],i=0;i<257;i++)for(j=0;j<257;j++){let a=Math.sqrt((j-128)*(j-128)+(128-i)*(128-i));a>1&&(e[257*i+j][0]=(Math.atan2(j-128,128-i)*rad2deg+360)%360,e[257*i+j][1]=Math.atan(257*(t[257*i+j]-obsHeight)/100/a)*rad2deg,e[257*i+j][2]=a)}if(e.sort((e,t)=>e[2]-t[2]),"view"==mode){for(ctx.fillStyle="rgba(0, 255, 0, 0.5)",ctx.beginPath(),i=0;i<66049;i++)[L,R]=l(...Ah2RADec(e[i][0],e[i][1],z)),Math.abs(R)<rgNS&&Math.abs(L)<rgEW&&(ctx.moveTo(...r(L,R)),ctx.arc(...r(L,R),1,0,2*pi,!1));ctx.fill()}else if(["live","ar"].includes(mode)){for(ctx.fillStyle="rgba(0, 255, 0, 0.5)",ctx.beginPath(),i=0;i<66049;i++)[L,R]=s(e[i][0],e[i][1]),Math.abs(L)<rgEW&&Math.abs(R)<rgNS&&(ctx.moveTo(...r(L,R)),ctx.arc(...r(L,R),1,0,2*pi,!1));ctx.fill()}}},e.readAsText(document.getElementById("demFileInput").files[0])}if(document.getElementById("aovCheck").checked&&(B(),"none"==document.getElementById("aovSliderDiv").style.display&&(document.getElementById("aovSliderDiv").style.display="block")),document.getElementById("aovCheck").checked||"none"==document.getElementById("aovSliderDiv").style.display||(document.getElementById("aovSliderDiv").style.display="none"),document.getElementById("center").checked){ctx.beginPath(),ctx.strokeStyle=starColor;const e=Math.min(canvas.width,canvas.height)/20;ctx.moveTo(canvas.width/2-e,canvas.height/2),ctx.lineTo(canvas.width/2+e,canvas.height/2),ctx.moveTo(canvas.width/2,canvas.height/2-e),ctx.lineTo(canvas.width/2,canvas.height/2+e),ctx.stroke()}let J=g(cenRA,cenDec);if(document.getElementById("constLineCheck").checked&&rgEW<=.5*document.getElementById("constLineFrom").value){for(ctx.strokeStyle=lineColor,ctx.beginPath(),i=0;i<89;i++)for(let e of constellations[i].lines){let t=e[0],a=e[1],n=e[2],i=e[3];if("AEP"==mode){let[e,l]=o(t,a),[s,c]=o(n,i);Math.min(e,s)<rgEW&&Math.max(e,s)>-rgEW&&Math.min(l,c)<rgNS&&Math.max(l,c)>-rgNS&&Math.pow(s-e,2)+Math.pow(c-l,2)<900&&(ctx.moveTo(...r(e,l)),ctx.lineTo(...r(s,c)))}else if("EtP"==mode){function Y(e,t,a,n,i){return Math.min(e,a)+i<cenRA+rgEW&&Math.max(e,a)+i>cenRA-rgEW&&Math.min(t,n)<cenDec+rgNS&&Math.max(t,n)>cenDec-rgNS}cenRA-rgEW<0?(Y(t,a,n,i,0)&&u(t,a,n,i,0),Y(t,a,n,i,-360)&&u(t,a,n,i,-360)):cenRA+rgEW>=360?(Y(t,a,n,i,0)&&u(t,a,n,i,0),Y(t,a,n,i,360)&&u(t,a,n,i,360)):Y(t,a,n,i,0)&&u(t,a,n,i,0)}else if("view"==mode){let[e,o]=l(t,a),[s,c]=l(n,i);Math.min(e,s)<rgEW&&Math.max(e,s)>-rgEW&&Math.min(o,c)<rgNS&&Math.max(o,c)>-rgNS&&Math.pow(s-e,2)+Math.pow(c-o,2)<900&&(ctx.moveTo(...r(e,o)),ctx.lineTo(...r(s,c)))}else if(["live","ar"].includes(mode)){let[e,o]=s(...RADec2Ah(t,a,z)),[l,c]=s(...RADec2Ah(n,i,z));Math.min(e,l)<rgEW&&Math.max(e,l)>-rgEW&&Math.min(o,c)<rgNS&&Math.max(o,c)>-rgNS&&Math.pow(l-e,2)+Math.pow(c-o,2)<900&&(ctx.moveTo(...r(e,o)),ctx.lineTo(...r(l,c)))}}ctx.stroke()}if(magLim>6.5&&0!=Tycho.length&&0!=Help.length){let e=[];if("AEP"==mode){let a=Math.max(-90,Math.min(scr2RADec(rgEW,-rgNS)[1],cenDec-rgNS)),n=Math.min(90,Math.max(scr2RADec(rgEW,rgNS)[1],cenDec+rgNS));if(-90==a)e=[[t(0,-90),t(359.9,n)]];else if(90==n)e=[[t(0,a),t(359.9,89.9)]];else{let i=(scr2RADec(rgEW,rgNS)[0]-cenRA+360)%360,o=(scr2RADec(rgEW,0)[0]-cenRA+360)%360,l=(scr2RADec(rgEW,-rgNS)[0]-cenRA+360)%360,s=Math.max(i,o,l);if(cenRA-s<0){e=[[t(0,a),t(cenRA+s,a)],[t(cenRA-s+360,a),t(359.9,a)]];for(let t=1;t<=Math.floor(n)-Math.floor(a);t++)e.push([e[0][0]+360*t,e[0][1]+360*t]),e.push([e[1][0]+360*t,e[1][1]+360*t])}else if(cenRA+s>360){e=[[t(0,a),t(cenRA+s,a)],[t(cenRA-s,a),t(359.9,a)]];for(let t=1;t<=Math.floor(n)-Math.floor(a);t++)e.push([e[0][0]+360*t,e[0][1]+360*t]),e.push([e[1][0]+360*t,e[1][1]+360*t])}else{e=[[t(cenRA-s,a),t(cenRA+s,a)]];for(let t=1;t<=Math.floor(n)-Math.floor(a);t++)e.push([e[0][0]+360*t,e[0][1]+360*t])}}p(e),magLim>10&&0!=Tycho1011.length&&0!=Help1011.length&&v(e)}else if("EtP"==mode){if(cenRA-rgEW<0){e=[[t(0,cenDec-rgNS),t(cenRA+rgEW,cenDec-rgNS)],[t(cenRA-rgEW+360,cenDec-rgNS),t(359.9,cenDec-rgNS)]];for(let t=1;t<=Math.floor(cenDec+rgNS)-Math.floor(cenDec-rgNS);t++)e.push([e[0][0]+360*t,e[0][1]+360*t]),e.push([e[1][0]+360*t,e[1][1]+360*t])}else if(cenRA+rgEW>=360){e=[[t(0,cenDec-rgNS),t(cenRA+rgEW-360,cenDec-rgNS)],[t(cenRA-rgEW,cenDec-rgNS),t(359.9,cenDec-rgNS)]];for(let t=1;t<=Math.floor(cenDec+rgNS)-Math.floor(cenDec-rgNS);t++)e.push([e[0][0]+360*t,e[0][1]+360*t]),e.push([e[1][0]+360*t,e[1][1]+360*t])}else{e=[[t(cenRA-rgEW,cenDec-rgNS),t(cenRA+rgEW,cenDec-rgNS)]];for(let t=1;t<=Math.floor(cenDec+rgNS)-Math.floor(cenDec-rgNS);t++)e.push([e[0][0]+360*t,e[0][1]+360*t])}p(e),magLim>10&&0!=Tycho1011.length&&0!=Help1011.length&&v(e)}else if("view"==mode){let[a,n]=l(0,90),[o,s]=l(0,-90);if(Math.abs(a)<rgEW&&Math.abs(n)<rgNS){let a=Math.min(Ah2RADec(...SHtoAh(rgEW,-rgNS),z)[1],Ah2RADec(...SHtoAh(-rgEW,-rgNS),z)[1],Ah2RADec(...SHtoAh(rgEW,rgNS),z)[1],Ah2RADec(...SHtoAh(-rgEW,rgNS),z)[1]);e=[[t(0,a),t(359.9,89.9)]]}else if(Math.abs(o)<rgEW&&Math.abs(s)<rgNS){let a=Math.max(Ah2RADec(...SHtoAh(rgEW,-rgNS),z)[1],Ah2RADec(...SHtoAh(-rgEW,-rgNS),z)[1],Ah2RADec(...SHtoAh(rgEW,rgNS),z)[1],Ah2RADec(...SHtoAh(-rgEW,rgNS),z)[1]);e=[[t(0,-90),t(359.9,a)]]}else{let a=0,n=360,o=-90,l=90,s=[],r=[];for(j=0;j<=Math.ceil(3*rgEW);j++)for(i=0;i<=Math.ceil(3*rgNS);i++)0<i&&i<Math.ceil(3*rgNS)&&0<j&&j<Math.ceil(3*rgEW)||([A,h]=SHtoAh((2*j/Math.ceil(3*rgEW)-1)*rgEW,(2*i/Math.ceil(3*rgNS)-1)*rgNS),[C,T]=Ah2RADec(A,h,z),s.push(C),r.push(T));if(o=Math.max(...r),l=Math.min(...r),a=Math.max(...s),n=Math.min(...s),a>330&&n<30){a=Math.max(...s.filter(function(e){return e<(cenRA+180)%360})),n=Math.min(...s.filter(function(e){return e>(cenRA+180)%360})),e=[[t(0,l),t(a,l)],[t(n,l),t(359.9,l)]];for(let t=1;t<=Math.floor(o)-Math.floor(l);t++)e.push([e[0][0]+360*t,e[0][1]+360*t]),e.push([e[1][0]+360*t,e[1][1]+360*t])}else{e=[[t(n,l),t(a,l)]];for(let t=1;t<=Math.floor(o)-Math.floor(l);t++)e.push([e[0][0]+360*t,e[0][1]+360*t])}}p(e),magLim>10&&0!=Tycho1011.length&&0!=Help1011.length&&v(e)}}for(document.getElementById("starNameCheck").checked&&rgEW<=.5*document.getElementById("starNameFrom").value&&S(),ctx.fillStyle=starColor,i=0;i<hips.length;i++)hips[i].mag>magLim||([k,_,F]=c(hips[i].ra,hips[i].dec),F&&e(k,_,hips[i].mag,m(hips[i].bv)));if(ctx.font="20px times new roman",document.getElementById("constNameCheck").checked&&rgEW<=.5*document.getElementById("constNameFrom").value)for(ctx.fillStyle=textColor,i=0;i<89;i++)if(C=parseFloat(constellations[i].ra),T=parseFloat(constellations[i].dec),[k,_,F]=c(C,T),F){let e=constellations[i].JPNname;ctx.fillText(e,k-40,_-10),infoList.push([e+"座",k,_])}if(ctx.font="16px serif",ctx.strokeStyle=objectColor,ctx.fillStyle=objectColor,document.getElementById("BayerFSCheck").checked&&0!=BayerNums.length&&y(),document.getElementById("MessierCheck").checked&&rgEW<=.5*document.getElementById("MessierFrom").value&&x(),document.getElementById("recsCheck").checked&&rgEW<=.5*document.getElementById("recsFrom").value&&void 0!==recs&&b(),document.getElementById("allNGCCheck").checked&&rgEW<=.5*document.getElementById("allNGCFrom").value&&0!=NGC.length&&I(),ctx.font="20px serif",ctx.textBaseline="bottom",ctx.textAlign="left",document.getElementById("planetCheck").checked){for(i=0;i<JPNplanets.length;i++)if([k,_,F]=c(solarSystemBodies[i].ra,solarSystemBodies[i].dec),i!=Obs_num&&F)if(0==i){let e=Math.max(canvas.width*(.267/solarSystemBodies[0].dist)/rgEW/2,13);f(k,_,e,yellowColor),document.getElementById("planetNameCheck").checked&&rgEW<=.5*document.getElementById("planetNameFrom").value&&(ctx.fillStyle=specialObjectNameColor,ctx.fillText(JPNplanets[i],k+Math.max(.8*e,10),_-Math.max(.8*e,10))),infoList.push([JPNplanets[i],k,_])}else if(9==i){if(3==Obs_num){let e=N();document.getElementById("planetNameCheck").checked&&rgEW<=.5*document.getElementById("planetNameFrom").value&&(ctx.fillStyle=specialObjectNameColor,ctx.fillText(JPNplanets[i],k+Math.max(.8*e,10),_-Math.max(.8*e,10))),infoList.push(["月",k,_])}}else 9!=i&&($=solarSystemBodies[i].mag,f(k,_,Math.max(d($),.5),"#F33"),document.getElementById("planetNameCheck").checked&&rgEW<=.5*document.getElementById("planetNameFrom").value&&(ctx.fillStyle=specialObjectNameColor,ctx.fillText(JPNplanets[i],k,_)),infoList.push([JPNplanets[i],k,_]));if(document.getElementById("planetTrackCheck").checked){let e=W,t=parseFloat(document.getElementById("trackSpan").value);"時間"==document.getElementById("trackUnit").value&&(t/=24);let a=parseFloat(document.getElementById("trackDuration").value),n=planets[JPNplanets.indexOf(trackPlanet)],i=0;for(;e-t>=showingJD-a;)e-=t,i--,D(n,e,i);for(e=W;e+t<=showingJD+a;)e+=t,i++,D(n,e,i)}}let U,G=`赤経 ${Math.floor(cenRA/15)}h ${(4*(cenRA-15*Math.floor(cenRA/15))).toFixed(1)}m `;U=cenDec>=0?`赤緯 +${Math.floor(cenDec)}° ${Math.round(60*(cenDec-Math.floor(cenDec)))}' (J2000.0) `:`赤緯 -${Math.floor(-cenDec)}° ${Math.round(60*(-cenDec-Math.floor(-cenDec)))}' (J2000.0) `;let X=`${J}　${rgtext}　${magLimtext}<br>${G}${U}<br>${H}${O}`;document.getElementById("coordtext").style.color=textColor,document.getElementById("coordtext").innerHTML=X}function sin(e){return Math.sin(e)}function cos(e){return Math.cos(e)}function Rx([e,t,a],n){return[e,cos(n)*t-sin(n)*a,sin(n)*t+cos(n)*a]}function Ry([e,t,a],n){return[cos(n)*e+sin(n)*a,t,-sin(n)*e+cos(n)*a]}function Rz([e,t,a],n){return[cos(n)*e-sin(n)*t,sin(n)*e+cos(n)*t,a]}function rahm2deg(e){let t=e.split(" ").map(Number);return 15*t[0]+t[1]/4}function decdm2deg(e){let t=e.split(" ").map(Number),a=Math.abs(t[0])+t[1]/60;return"-"==e[0]&&(a*=-1),a}function hourAngle(e,t){let a=(e-2451545)/36525;return 2*((24110.54841+8640184.812866*a+.093104*a**2-62e-7*a**3)/86400%1+(e-8e-4-2451544.5)%1*1.00273781)*pi+t}function RADec2Ah(e,t,a){e*=deg2rad,t*=deg2rad;let[n,i,o]=Ry([sin(t),cos(t)*sin(a-e),cos(t)*cos(a-e)],-lat_obs),l=(Math.atan2(-i,n)*rad2deg+360)%360,s=Math.asin(o)*rad2deg;return[l,s]}function Ah2RADec(e,t,a){e*=deg2rad,t*=deg2rad;let[n,i,o]=Ry([cos(t)*cos(e),-cos(t)*sin(e),sin(t)],lat_obs),l=((a-Math.atan2(i,o))*rad2deg+360)%360,s=Math.asin(n)*rad2deg;return[l,s]}function scr2RADec(e,t){if(0==e&&0==t)return[cenRA,cenDec];{let a=Math.atan2(e,-t),n=Math.sqrt(e*e+t*t)*deg2rad,i=cenDec*deg2rad,o=sin(i)*sin(n)*cos(a)+cos(i)*cos(n),l=sin(n)*sin(a),s=-cos(i)*sin(n)*cos(a)+sin(i)*cos(n),r=Math.asin(s)*rad2deg,c=((Math.atan2(l,o)*rad2deg+cenRA)%360+360)%360;return[c,r]}}function SHtoAh(e,t){let a,n;if(0==e&&0==t)a=cenAzm,n=cenAlt;else{let i=Math.atan2(e,-t),o=Math.sqrt(e*e+t*t)*deg2rad,l=cenAzm*deg2rad,s=cenAlt*deg2rad,[r,c,d]=Rz(Ry([sin(o)*cos(i),sin(o)*sin(i),cos(o)],pi/2-s),-l);n=Math.asin(d)*rad2deg,a=(Math.atan2(-c,r)*rad2deg%360+360)%360}return[a,n]}function screen2liveAh(e,t){let a=Math.atan2(t,-e),n=Math.sqrt(e*e+t*t)*deg2rad,[i,o,l]=Rz(Rx(Ry([sin(n)*cos(a),sin(n)*sin(a),-cos(n)],dev_c),dev_b),dev_a),s=Math.asin(l)*rad2deg,r=((Math.atan2(-o,i)*rad2deg+loadAzm+90)%360+360)%360;return[r,s]}function xyz_to_RADec(e,t,a){let n,i;return dist=Math.sqrt(e*e+t*t+a*a),dist<1e-8?(n=0,i=200):(n=(Math.atan2(t,e)*rad2deg+360)%360,i=Math.atan(a/Math.sqrt(e*e+t*t))*rad2deg),[n,i,dist]}function JD_to_YMDHM(e){let t=e+.375-8e-4+1/2880,a=Math.floor(t+68569.5),n=Math.floor(a/36524.25),i=a-Math.floor(36524.25*n+.75),o=Math.floor((i+1)/365.25025),l=i-Math.floor(365.25*o)+31,s=Math.floor(l/30.59),r=l-Math.floor(30.59*s),c=Math.floor(s/11),d=s-12*c+2,m=100*(n-49)+o+c,h=Math.floor(24*(t+.5-Math.floor(t+.5))),g=Math.floor(1440*(t+.5-Math.floor(t+.5))-60*h);return 12==d&&32==r&&(m+=1,d=1,r=1),[m,d,r,h,g]}function YMDHM_to_JD(e,t,a,n,i){t<=2&&(t+=12,e--);let o=Math.floor(365.25*e)+Math.floor(e/400)-Math.floor(e/100)+Math.floor(30.59*(t-2))+a+n/24+i/1440+1721088.5+8e-4-.375;return o}function determinMagLim(e,t){let a=Math.min(Math.max(e-t*Math.log(Math.min(rgEW,rgNS)),5),magLimLim);return magLimtext=`~${a.toFixed(1)}等級`,a}function determinZerosize(){return 13-2.4*Math.log(Math.min(rgEW,rgNS)+3)}function newSetting(){ObsPlanet=document.getElementById("observer").value,Obs_num=JPNplanets.indexOf(ObsPlanet),"地球"==ObsPlanet?(url.searchParams.has("observer")&&url.searchParams.delete("observer"),localStorage.setItem("observer_planet","Earth")):(url.searchParams.set("observer",ENGplanets[Obs_num].split(" ").join("").split("/").join("")),localStorage.setItem("observer_planet",ENGplanets[Obs_num].split(" ").join("").split("/").join("")));for(let e=0;e<zuhoElem.length;e++)if(zuhoElem[e].checked){mode=zuhoElem[e].value,setUrlAndLocalStorage("mode",mode);break}turnOnOffLiveMode(mode),setUrlAndLocalStorage("magkey",document.getElementById("magLimitSlider").value),magLimLim=["live","ar"].includes(mode)?6.5:11,magLim=determinMagLim(magkey1,magkey2),zerosize=determinZerosize(),"北緯"==document.getElementById("NSCombo").value?(lat_obs=document.getElementById("lat").value*deg2rad,lattext=document.getElementById("lat").value+"°N","35"==document.getElementById("lat").value?(url.searchParams.has("lat")&&url.searchParams.delete("lat"),localStorage.setItem("lat","35")):setUrlAndLocalStorage("lat",document.getElementById("lat").value)):(lat_obs=-document.getElementById("lat").value*deg2rad,lattext=document.getElementById("lat").value+"°S",setUrlAndLocalStorage("lat",-document.getElementById("lat").value)),"東経"==document.getElementById("EWCombo").value?(lon_obs=document.getElementById("lon").value*deg2rad,lontext=document.getElementById("lon").value+"°E","135"==document.getElementById("lon").value?(url.searchParams.has("lon")&&url.searchParams.delete("lon"),localStorage.setItem("lon","135")):setUrlAndLocalStorage("lon",document.getElementById("lon").value)):(lon_obs=-document.getElementById("lon").value*deg2rad,lontext=document.getElementById("lon").value+"°W",setUrlAndLocalStorage("lon",-document.getElementById("lon").value)),setRealtime(),timeSliderElem.value=0,timeSliderValue=0,calculation(showingJD)}function setUrlAndLocalStorage(e,t){url.searchParams.set(e,t),localStorage.setItem(e,t)}function setRealtime(){let e=new Date;if(document.getElementById("showingData").style.color=textColor,realtimeElem[0].checked){timeSliderElem.style.visibility="visible";let e=parseInt(yearTextElem.value),t=parseInt(monthTextElem.value),a=parseInt(dateTextElem.value),n=parseInt(hourTextElem.value),i=parseFloat(minuteTextElem.value);document.getElementById("showingData").innerHTML=`${e}/${t}/${a} ${n}:${i.toString().padStart(2,"0")} (JST) ${lattext} ${lontext}`,showingJD=YMDHM_to_JD(e,t,a,n,i),null!==intervalId&&(clearInterval(intervalId),intervalId=null),setUrlAndLocalStorage("time",`${e}-${t}-${a}-${n}-${i}`),localStorage.setItem("realtime","off")}else if(realtimeElem[1].checked){timeSliderElem.style.visibility="hidden";let[t,a,n,i,o]=[e.getFullYear(),e.getMonth()+1,e.getDate(),e.getHours(),parseFloat((e.getMinutes()+e.getSeconds()/60).toFixed(1))];document.getElementById("showingData").innerHTML=`${t}/${a}/${n} ${i}:${o.toString().padStart(2,"0")} (JST) ${lattext} ${lontext}`,showingJD=YMDHM_to_JD(t,a,n,i,o),null!==intervalId&&(clearInterval(intervalId),intervalId=null),intervalId=setInterval(realtimeRadec,500),setYMDHM(t,a,n,i,o),setUrlAndLocalStorage("time",`${t}-${a}-${n}-${i}-${o}`),localStorage.setItem("realtime","radec")}else if(realtimeElem[2].checked){timeSliderElem.style.visibility="hidden";let[t,a,n,i,o]=[e.getFullYear(),e.getMonth()+1,e.getDate(),e.getHours(),parseFloat((e.getMinutes()+e.getSeconds()/60).toFixed(1))];document.getElementById("showingData").innerHTML=`${t}/${a}/${n} ${i}:${o.toString().padStart(2,"0")} (JST) ${lattext} ${lontext}`,showingJD=YMDHM_to_JD(t,a,n,i,o),null!==intervalId&&(clearInterval(intervalId),intervalId=null),intervalId=setInterval(realtimeAzmalt,500),setYMDHM(t,a,n,i,o),setUrlAndLocalStorage("time",`${t}-${a}-${n}-${i}-${o}`),localStorage.setItem("realtime","azmalt")}history.replaceState("","",url.href)}function realtimeOff(){realtimeElem[1].checked=!1,realtimeElem[2].checked=!1,realtimeElem[0].checked=!0,timeSliderElem.style.visibility="visible";let e=parseInt(yearTextElem.value),t=parseInt(monthTextElem.value),a=parseInt(dateTextElem.value),n=parseInt(hourTextElem.value),i=parseFloat(minuteTextElem.value);document.getElementById("showingData").innerHTML=`${e}/${t}/${a} ${n}:${i.toString().padStart(2,"0")} (JST) ${lattext} ${lontext}`,showingJD=YMDHM_to_JD(e,t,a,n,i),null!==intervalId&&(clearInterval(intervalId),intervalId=null),setUrlAndLocalStorage("time",`${e}-${t}-${a}-${n}-${i}`),localStorage.setItem("realtime","off")}function realtimeRadec(){let e=new Date;if(e.getSeconds()%6==0&&e.getMilliseconds()<500){let[t,a,n,i,o]=[e.getFullYear(),e.getMonth()+1,e.getDate(),e.getHours(),(e.getMinutes()+e.getSeconds()/60).toFixed(1)];document.getElementById("showingData").style.color=textColor,document.getElementById("showingData").innerHTML=`${t}/${a}/${n} ${i}:${o.padStart(2,"0")} (JST) ${lattext} ${lontext}`,setUrlAndLocalStorage("time",`${t}-${a}-${n}-${i}-${o}`),localStorage.setItem("realtime","radec"),history.replaceState("","",url.href),setYMDHM(t,a,n,i,o),showingJD=YMDHM_to_JD(t,a,n,i,o),calculation(showingJD),[cenAzm,cenAlt]=RADec2Ah(cenRA,cenDec,theta),show_main()}}function realtimeAzmalt(){let e=new Date;if(e.getSeconds()%6==0&&e.getMilliseconds()<500){let[t,a,n,i,o]=[e.getFullYear(),e.getMonth()+1,e.getDate(),e.getHours(),(e.getMinutes()+e.getSeconds()/60).toFixed(1)];document.getElementById("showingData").style.color=textColor,document.getElementById("showingData").innerHTML=`${t}/${a}/${n} ${i}:${o.padStart(2,"0")} (JST) ${lattext} ${lontext}`,setUrlAndLocalStorage("time",`${t}-${a}-${n}-${i}-${o}`),localStorage.setItem("realtime","azmalt"),history.replaceState("","",url.href),setYMDHM(t,a,n,i,o),showingJD=YMDHM_to_JD(t,a,n,i,o),calculation(showingJD),[cenRA,cenDec]=Ah2RADec(cenAzm,cenAlt,theta),show_main()}}function loadFiles(){function e(e){const t=e.split(",");for(hips=Array(t.length/4),i=0;i<t.length/4;i++)hips[i]={ra:parseFloat(t[4*i]),dec:parseFloat(t[4*i+1]),mag:parseFloat(t[4*i+2]),bv:t[4*i+3]}}function t(e){const t=e.split(",");for(BSCnum=t.length/6,BSCRAary=Array(BSCnum),BSCDecary=Array(BSCnum),FSs=Array(BSCnum),Bayers=Array(BSCnum),BayerNums=Array(BSCnum),i=0;i<BSCnum;i++)BSCRAary[i]=parseFloat(t[6*i]),BSCDecary[i]=parseFloat(t[6*i+1]),FSs[i]=t[6*i+2],Bayers[i]=t[6*i+3],BayerNums[i]=t[6*i+4]}function a(e){const t=e.split("\n");for(let e=0;e<t.length&&0!=t[e].length;e++){let a=t[e].split(" "),n=a[1];for(let e=2;e<parseInt(a[0])+1;e++)n+=" "+a[e];ENGplanets.push(n),JPNplanets.push(n);let i=[];for(let e=parseInt(a[0])+1;e<a.length-4;e++)i.push(parseFloat(a[e]));planets.push(i);const o=document.createElement("option");o.innerHTML=n,document.getElementById("observer").appendChild(o)}if(url.searchParams.has("observer")){for(let e=0;e<ENGplanets.length;e++)if(url.searchParams.get("observer")==ENGplanets[e].split(" ").join("").split("/").join("")){document.getElementById("observer").value=JPNplanets[e];break}defaultcheck++}else if(null!=localStorage.getItem("observer_planet")&&"Earth"!=localStorage.getItem("observer_planet")){for(let e=0;e<ENGplanets.length;e++)if(localStorage.getItem("observer_planet")==ENGplanets[e].split(" ").join("").split("/").join("")){document.getElementById("observer").value=JPNplanets[e];break}defaultcheck++}else defaultcheck++}if(online){function n(e,t,a=!1){let n="https://peteworden.github.io/Soleil/data/"+e+".txt",i=new XMLHttpRequest;i.open("GET",n),i.send(),i.onreadystatechange=function(){if(4===i.readyState&&200===i.status)return t(i.responseText),xhrcheck++,a&&xhrimpcheck++,loaded.push(e),console.log(`${xhrcheck} ${defaultcheck} ${e}.txt`),show_initial(),0}}function o(e,t,a=!1){fetch(`https://peteworden.github.io/Soleil/data/${e}.json`).then(e=>{if(!e.ok)throw new Error("Network response was not ok");return e.json()}).then(n=>{t(n),xhrcheck++,a&&xhrimpcheck++,loaded.push(e),console.log(`${xhrcheck} ${defaultcheck} ${e}.json`),show_initial()}).catch(e=>{console.error("There was a problem with the fetch operation:",e)})}n("hip_65",e,!0),o("constellation",e=>{constellations=e},!0),n("constellation_boundaries",e=>{boundary=e.split(",").map(Number)},!0),o("starname",e=>{starNames=e},!0),o("messier",e=>{messier=e},!0),n("tycho2_100",e=>{Tycho=e.split(",").map(Number)}),n("tycho2_100_helper",e=>{Help=e.split(",").map(Number)}),n("tycho2_100-110",e=>{Tycho1011=e.split(",").map(Number)}),n("tycho2_100-110_helper",e=>{Help1011=e.split(",").map(Number)}),n("additional_objects",a),n("brights",t),o("rec",e=>{recs=e}),n("ngc",e=>{NGC=e.split(",")})}else document.getElementById("getFile").addEventListener("change",function(){let n=new FileReader;n.onload=function(){const i=n.result.split("||||");for(let n=0;n<13;n++){fn=i[n].split("::::")[0];let o=i[n].split("::::")[1];"hip_65"==fn&&(e(o),xhrimpcheck++),"tycho2_100"===fn&&(Tycho=o.split(",").map(Number)),"tycho2_100_helper"==fn&&(Help=o.split(",").map(Number)),"tycho2_100-110_helper"==fn&&(Tycho1011=o.split(",").map(Number)),"tycho2_100-110_helper"==fn&&(Help1011=o.split(",").map(Number)),"brights"==fn&&t(o),"starname"==fn&&(starNames=JSON.parse(o),xhrimpcheck++),"messier"==fn&&(messier=JSON.parse(o),xhrimpcheck++),"rec"==fn&&(recs=JSON.parse(o)),"ngc"==fn&&(NGC=o.split(",")),"constellation"==fn&&(constellations=JSON.parse(o),xhrimpcheck++),"constellation_boundaries"==fn&&(boundary=o.split(",").map(Number),xhrimpcheck++),"additional_objects"==fn&&a(o),xhrcheck++,show_initial()}},n.readAsText(this.files[0])})}function checkURL(){if(url.searchParams.has("RA")&&!isNaN(url.searchParams.get("RA"))?(cenRA=+url.searchParams.get("RA"),localStorage.setItem("RA",cenRA),defaultcheck++,show_initial()):null==localStorage.getItem("RA")||isNaN(localStorage.getItem("RA"))?(setUrlAndLocalStorage("RA",cenRA),defaultcheck++,show_initial()):(cenRA=+localStorage.getItem("RA"),url.searchParams.set("RA",cenRA),defaultcheck++,show_initial()),url.searchParams.has("Dec")&&!isNaN(url.searchParams.get("Dec"))?(cenDec=+url.searchParams.get("Dec"),localStorage.setItem("Dec",cenDec),defaultcheck++,show_initial()):null==localStorage.getItem("Dec")||isNaN(localStorage.getItem("Dec"))?(setUrlAndLocalStorage("Dec",cenDec),defaultcheck++,show_initial()):(cenDec=+localStorage.getItem("Dec"),url.searchParams.set("Dec",cenDec),defaultcheck++,show_initial()),url.searchParams.has("azm")&&!isNaN(url.searchParams.get("azm"))?(cenAzm=+url.searchParams.get("azm"),localStorage.setItem("azm",cenAzm),defaultcheck++,show_initial()):null==localStorage.getItem("azm")||isNaN(localStorage.getItem("azm"))?(setUrlAndLocalStorage("azm",cenAzm),defaultcheck++,show_initial()):(cenAzm=+localStorage.getItem("azm"),url.searchParams.set("azm",cenAzm),defaultcheck++,show_initial()),url.searchParams.has("alt")&&!isNaN(url.searchParams.get("alt"))?(cenAlt=+url.searchParams.get("alt"),localStorage.setItem("alt",cenAlt),defaultcheck++,show_initial()):null==localStorage.getItem("alt")||isNaN(localStorage.getItem("alt"))?(setUrlAndLocalStorage("alt",cenAlt),defaultcheck++,show_initial()):(cenAlt=+localStorage.getItem("alt"),url.searchParams.set("alt",cenAlt),defaultcheck++,show_initial()),url.searchParams.has("time")){let[e,t,a,n,i]=url.searchParams.get("time").split("-");setYMDHM(e,t,a,n,i),showingJD=YMDHM_to_JD(e,t,a,n,i),realtimeOff(),defaultcheck++,show_initial()}else null!=localStorage.getItem("realtime")?("radec"==localStorage.getItem("realtime")?(realtimeElem[2].checked=!1,realtimeElem[1].checked=!0):"off"==localStorage.getItem("realtime")&&(realtimeElem[2].checked=!1,realtimeElem[0].checked=!0),defaultcheck++,show_initial()):(now(),defaultcheck++,show_initial());if(url.searchParams.has("mode")&&["AEP","EtP","view","live","ar"].includes(url.searchParams.get("mode"))){mode=url.searchParams.get("mode");for(let e=0;e<zuhoElem.length;e++)if(zuhoElem[e].value==mode){zuhoElem[e].checked=!0;break}turnOnOffLiveMode(mode),defaultcheck++,show_initial()}else{for(let e=0;e<zuhoElem.length;e++)zuhoElem[e].checked&&(mode=zuhoElem[e].value,url.searchParams.set("mode",mode));turnOnOffLiveMode(mode),defaultcheck++,show_initial()}if(url.searchParams.has("area")&&!isNaN(url.searchParams.get("area"))?(rgEW=parseFloat(url.searchParams.get("area"))/2,rgNS=rgEW*canvas.height/canvas.width,rgtext=`視野(左右):${(2*rgEW).toFixed(1)}°`,magLimLim=["live","ar"].includes(mode)?6.5:11,magLim=determinMagLim(magkey1,magkey2),zerosize=determinZerosize(),defaultcheck++,show_initial()):(url.searchParams.set("area",(2*rgEW).toFixed(2)),defaultcheck++,show_initial()),url.searchParams.has("magkey")&&!isNaN(url.searchParams.get("magkey"))?(magkey1=parseFloat(url.searchParams.get("magkey")),document.getElementById("magLimitSlider").value=magkey1,magLim=determinMagLim(magkey1,magkey2),zerosize=determinZerosize(),defaultcheck++,show_initial()):(defaultcheck++,show_initial()),url.searchParams.has("lat")&&!isNaN(url.searchParams.get("lat"))?(lat_obs=url.searchParams.get("lat")*deg2rad,lat_obs>=0?(document.getElementById("NSCombo").value="北緯",document.getElementById("lat").value=url.searchParams.get("lat")):(document.getElementById("NSCombo").value="南緯",document.getElementById("lat").value=-url.searchParams.get("lat")),defaultcheck++,show_initial()):(defaultcheck++,show_initial()),url.searchParams.has("lon")&&!isNaN(url.searchParams.get("lon"))?(lon_obs=url.searchParams.get("lon")*deg2rad,lon_obs>=0?(document.getElementById("EWCombo").value="東経",document.getElementById("lon").value=url.searchParams.get("lon")):(document.getElementById("EWCombo").value="西経",document.getElementById("lon").value=-url.searchParams.get("lon")),defaultcheck++,show_initial()):(defaultcheck++,show_initial()),null!=localStorage.getItem("lastVisit")){lastVisitDate=new Date(localStorage.getItem("lastVisit"));const e=new Date;localStorage.setItem("lastVisit",e.toISOString())}else{lastVisitDate=new Date,localStorage.setItem("lastVisit",lastVisitDate.toISOString());let e=lastVisitDate.getMonth();0===e?(lastVisitDate.setFullYear(lastVisitDate.getFullYear()-1),lastVisitDate.setMonth(11)):lastVisitDate.setMonth(e-1)}showNews(lastVisitDate)}function turnOnOffLiveMode(e){if(["live","ar"].includes(e)?"iphone"==os?window.addEventListener("deviceorientation",deviceOrientation,!0):"android"==os&&window.addEventListener("deviceorientationabsolute",deviceOrientation,!0):"iphone"==os?window.removeEventListener("deviceorientation",deviceOrientation,!0):"android"==os&&window.removeEventListener("deviceorientationabsolute",deviceOrientation,!0),"ar"!=e||videoOn){if("ar"!=e&&videoOn){skycolor="#001";let e={audio:!1,video:{facingMode:"environment"}};navigator.mediaDevices.getUserMedia(e).then(function(e){let t=document.getElementById("arVideo");t.srcObject=e,t.onloadedmetadata=function(t){e.getVideoTracks()[0].stop()}}),videoOn=!1}}else{skycolor="rgba("+[0,0,1,.1]+")";let e={audio:!1,video:{facingMode:"environment"}};navigator.mediaDevices.getUserMedia(e).then(function(e){let t=document.getElementById("arVideo");t.srcObject=e,t.onloadedmetadata=function(e){t.play()},document.body.appendChild(t),setPicsFor360()}),videoOn=!0}}function deviceOrientation(e){"iphone"==os&&0==loadAzm&&(loadAzm=e.webkitCompassHeading);let t=Date.now();t-orientationTime1>100&&(orientationTime1=t,Math.max(Math.abs(dev_a-e.alpha),Math.abs(dev_b-e.beta),Math.abs(dev_c-e.gamma))<10?dev_a_array.length>2?(dev_a_sum+=e.alpha*deg2rad-dev_a_array.pop(),dev_b_sum+=e.beta*deg2rad-dev_b_array.pop(),dev_c_sum+=e.gamma*deg2rad-dev_c_array.pop(),dev_a_array.unshift(e.alpha*deg2rad),dev_b_array.unshift(e.beta*deg2rad),dev_c_array.unshift(e.gamma*deg2rad),moving=Math.abs(dev_a_sum/3-dev_a)>.2,dev_a=dev_a_sum/3,dev_b=dev_b_sum/3,dev_c=dev_c_sum/3):(dev_a_sum+=e.alpha*deg2rad,dev_b_sum+=e.beta*deg2rad,dev_c_sum+=e.gamma*deg2rad,dev_a_array.unshift(e.alpha*deg2rad),dev_b_array.unshift(e.beta*deg2rad),dev_c_array.unshift(e.gamma*deg2rad),dev_a=dev_a_sum/dev_a_array.length,dev_b=dev_b_sum/dev_b_array.length,dev_c=dev_c_sum/dev_c_array.length):(dev_a=e.alpha*deg2rad,dev_b=e.beta*deg2rad,dev_c=e.gamma*deg2rad,dev_a_sum=dev_a+0,dev_b_sum=dev_b+0,dev_c_sum=dev_c+0,dev_a_array=[dev_a],dev_b_array=[dev_b],dev_c_array=[dev_c]),show_initial())}function showNews(e){const t=document.getElementById("newsText");t.innerHTML="";let a,n,i="";for(let o=0;o<news.length;o++){let l=new Date(news[o].time);if(l>e)if(news[o].time.split("T")[0]==i)news[o].text.forEach(e=>{const t=document.createElement("li");t.textContent=e,n.appendChild(t)});else{a&&(a.appendChild(n),t.appendChild(a)),a=document.createElement("div"),i=news[o].time.split("T")[0];let e=document.createElement("p");e.textContent=`${i}`,a.appendChild(e),n=document.createElement("ul"),news[o].text.forEach(e=>{const t=document.createElement("li");t.textContent=e,n.appendChild(t)})}}a&&(a.appendChild(n),t.appendChild(a),document.getElementById("news").style.visibility="visible")}function darkerFunc(){darker?(darker=!1,starColor="#FFF",yellowColor="yellow",objectColor="orange",lineColor="red",textColor="white",specialObjectNameColor="#FF8",document.getElementById("darkerbtntext").innerHTML="dark"):(darker=!0,starColor="#C66",yellowColor="#550",objectColor="#D55",lineColor="#700",textColor="#A53",specialObjectNameColor="#AA5",document.getElementById("darkerbtntext").innerHTML="bright"),newSetting(),show_main()}function showSetting(){if(document.getElementById("descriptionBtn").setAttribute("disabled",!0),document.getElementById("setting").style.visibility="visible","iphone"==os&&!orientationPermittion)for(i=0;i<permitBtns.length;i++)permitBtns[i].style.visibility="visible"}function finishSetting(){for(newSetting(),show_main(),document.getElementById("descriptionBtn").removeAttribute("disabled"),document.getElementById("setting").style.visibility="hidden",i=0;i<permitBtns.length;i++)permitBtns[i].style.visibility="hidden"}function descriptionFunc(){"visible"==document.getElementById("description").style.visibility?(document.getElementById("settingBtn").removeAttribute("disabled"),document.getElementById("description").style.visibility="hidden"):(document.getElementById("settingBtn").setAttribute("disabled",!0),document.getElementById("description").style.visibility="visible")}function toggleFullscreen(){let e=document.documentElement;e.requestFullscreen({navigationUI:"show"}).then(()=>{}).catch(e=>{alert(`An error occurred while trying to switch into fullscreen mode: ${e.message} (${e.name})`)})}function fullScreenFunc(){toggleFullscreen(),setCanvas(!0),document.getElementById("fullScreenBtn").style.visibility="hidden",document.getElementById("exitFullScreenBtn").style.visibility="visible"}function exitFullScreenFunc(){document.exitFullscreen(),setCanvas(!1),document.getElementById("fullScreenBtn").style.visibility="visible",document.getElementById("exitFullScreenBtn").style.visibility="hidden"}function openSearch(){document.getElementById("searchDiv").style.visibility="visible",document.getElementById("suggestionButtonContainer").innerHTML=""}function closeSearch(){document.getElementById("searchDiv").style.visibility="hidden"}function closeNews(){document.getElementById("news").style.visibility="hidden"}function closeObjectInfo(){document.getElementById("objectInfo").style.visibility="hidden",document.getElementById("planetTrack").style.display="none",show_main()}function show_JD_plus1(){showingJD++,setYMDHM(...JD_to_YMDHM(showingJD)),realtimeOff()}function show_JD_minus1(){
showingJD--,setYMDHM(...JD_to_YMDHM(showingJD)),realtimeOff()}const online=navigator.onLine,pi=Math.PI,rad2deg=180/pi,deg2rad=pi/180,eps=.4090926,sine=sin(eps),cose=cos(eps),yearTextElem=document.getElementById("yearText"),monthTextElem=document.getElementById("monthText"),dateTextElem=document.getElementById("dateText"),hourTextElem=document.getElementById("hourText"),minuteTextElem=document.getElementById("minuteText"),aovSliderElem=document.getElementById("aovSlider"),timeSliderElem=document.getElementById("timeSlider");let zuhoElem=document.getElementsByName("mode");const permitBtns=document.getElementsByClassName("permitBtn"),realtimeElem=document.getElementsByName("realtime"),trackDateElem=document.getElementsByName("trackTime");document.getElementById("welcomeImage").style.visibility="hidden",online?(document.getElementById("fileBtn").style.visibility="hidden",document.getElementById("getFile").style.visibility="hidden"):alert("offline version\nSelect allInOne.txt from the file button"),document.getElementById("setting").style.visibility="hidden",document.getElementById("exitFullScreenBtn").style.visibility="hidden",document.getElementById("description").style.visibility="hidden",document.getElementById("setPicsFor360Div").style.visibility="hidden",document.getElementById("demDescriptionDiv").style.visibility="hidden",document.getElementById("searchDiv").style.visibility="hidden",document.getElementById("news").style.visibility="hidden",document.getElementById("objectInfo").style.visibility="hidden",document.getElementById("darkerbtntext").innerHTML="dark";let darker=!1,skycolor="#001",starColor="#FFF",yellowColor="yellow",objectColor="orange",specialObjectNameColor="#FF8",lineColor="red",textColor="white",cenRA=270,cenDec=-25,cenAzm=180,cenAlt=60,dev_a=180*deg2rad,dev_b=120*deg2rad,dev_c=0*deg2rad,dev_a_array=[],dev_b_array=[],dev_c_array=[],dev_a_sum=0,dev_b_sum=0,dev_c_sum=0;const minrg=.3,maxrg=90;let rgEW,rgNS,rgtext,theta,mode,ObsPlanet,Obs_num,lat_obs,lon_obs,lattext,lontext,Ms,ws,lon_moon,lat_moon,hips,starNames,messier,recs,constellations,showingJD=0,Tycho=new Array(980634),Help=new Array(64801),Tycho1011=new Array(1602511),Help1011=new Array(64801),BSCnum=0,BSCRAary=Array(1),BSCDecary=Array(1),FSs=Array(1),Bayers=Array(1),BayerNums=Array(1),NGC=new Array(66130),boundary=new Array(4801);const Sun=["Sun"],Marcury=[2451545,.387099,.205636,29.12703,7.004979,48.330766,174.792527,0,19e-6,.285818,-.005947,-.125341],Venus=[2451545,.723336,.006777,54.922625,3.394676,76.679843,50.376632,4e-6,-41e-6,.280377,-789e-6,-.277694],Earth=[2451545,1.000003,.016711,102.937682,-15e-6,0,-2.47311,6e-6,-44e-6,.323274,-.012947,0],Mars=[2451545,1.52371,.093394,286.496832,1.849691,49.559539,19.390198,18e-6,79e-6,.736984,-.008131,-.292573],Jupiter=[2451545,5.202887,.048386,274.254571,1.304397,100.473909,19.667961,-116e-6,-133e-6,.007836,-.001837,.204691],Saturn=[2451545,9.536676,.053862,-21.063546,2.485992,113.662424,317.355366,-.001251,-51e-5,-.130294,.001936,-.288678],Uranus=[2451545,19.189165,.047257,96.937351,.772638,74.016925,142.283828,-.001962,-44e-6,.365647,-.002429,.042406],Neptune=[2451545,30.069923,.00859,273.180537,1.770043,131.784226,259.915208,263e-6,51e-6,-.317328,354e-6,-.005087],Moon=["Moon"],Ceres=[2459396.5,2.76566,.07839,73.738268,10.588196,80.267638,247.549972,0,0,0,0,0,3.53,.12],Vesta=[2459396.5,2.36166,.08835,151.015603,7.141541,103.806059,311.692061,0,0,0,0,0,3.31,.32],planets=[Sun,Marcury,Venus,Earth,Mars,Jupiter,Saturn,Uranus,Neptune,Moon,Ceres,Vesta],OriginalNumOfPlanets=planets.length;let lastVisitDate,os,ENGplanets=["Sun","Mercury","Venus","Earth","Mars","Jupiter","Saturn","Uranus","Neptune","Moon","Ceres","Vesta"],JPNplanets=["太陽","水星","金星","地球","火星","木星","土星","天王星","海王星","月","Ceres","Vesta"],solarSystemBodies=new Array(20),infoList=[],xhrcheck=0,xhrimpcheck=0,defaultcheck=0,loaded=[],news=[{time:"2025-01-11T00:00:00+09:00",text:["月が表示されないバグを修正。小豆ありがとう","リロード時の時刻設定を現在時刻にしました","右下の?ボタンにブックマーク用のURLを書きました。少し前にご意見フォームも設置しています"]},{time:"2025-01-09T16:00:00+09:00",text:["C/2024 G3(ATLAS彗星)などが加わりました"]}],intervalId=null,moving=!1,picsFor360=5,videoHeight=1,videoWidth=1,videoOn=!1,orientationPermittion=!0,loadAzm=0,orientationTime1=Date.now(),canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");const BIGWIDTH=window.screen.width,BIGHEIGHT=window.screen.height-30,NORMALWIDTH=window.innerWidth,NORMALHEIGHT=window.innerHeight-30;let magLimtext;setCanvas(!1),canvas.width<canvas.height?(rgEW=20,rgNS=rgEW*canvas.height/canvas.width,document.getElementById("constNameFrom").value="90",document.getElementById("MessierFrom").value="60",document.getElementById("recsFrom").value="50"):(rgNS=20,rgEW=rgNS*canvas.width/canvas.height,document.getElementById("constNameFrom").value="180",document.getElementById("MessierFrom").value="180",document.getElementById("recsFrom").value="120"),rgtext=`視野(左右):${(2*rgEW).toFixed(1)}°`;let magLimLim=11,magkey1=11,magkey2=1.8,magLim=determinMagLim(magkey1,magkey2),zerosize=determinZerosize();document.getElementById("magLimitSlider").addEventListener("change",function(){magkey1=document.getElementById("magLimitSlider").value,magLim=determinMagLim(magkey1,magkey2),zerosize=determinZerosize()}),init();const url=new URL(window.location.href);setPicsFor360(),document.getElementById("searchInput").addEventListener("input",function(){let e=toUpperCaseOrKatakana(document.getElementById("searchInput").value),t=[[],[]],a=[[],[]],n=[];if(0==e.length)t=[[],[]],a=[[],[]];else if(1==e.length){if(isNaN(e)&&!["M","N","I"].includes(e)){for(i=0;i<89;i++)constellations[i].JPNname.length&&toUpperCaseOrKatakana(constellations[i].JPNname[0])==e&&(t[0].push(`${constellations[i].JPNname}座`),t[1].push(`${constellations[i].JPNname}座`));for(i=0;i<starNames.length;i++)starNames[i].name.length&&toUpperCaseOrKatakana(starNames[i].name[0])==e&&(t[0].push(starNames[i].name),t[1].push(starNames[i].name))}if(!isNaN(e)&&1<=parseInt(e)<=110&&linkExist(`M${e}`)&&(t[0].push(`M${e}`),t[1].push(`M${e}`)),isNaN(e)){if(!["M","N","I"].includes(e))for(m of messier)for(alt of m.alt_name)alt.length>0&&toUpperCaseOrKatakana(alt[0])==e&&(t[0].push(m.name),t[1].push(m.name));for(let a of recs){a.name.length&&toUpperCaseOrKatakana(a.name[0])==e&&(t[0].push(a.name),t[1].push(a.name));for(let n of a.alt_name)n.length&&toUpperCaseOrKatakana(n[0])==e&&(t[0].push(`${a.name}(${n})`),t[1].push(a.name))}}else{for(let a of recs){[`NGC${e}`,`IC${e}`,`Cr${e}`].includes(a.name)&&(t[0].push(a.name),t[1].push(a.name),n.push(a.name));for(let i of a.alt_name)[`NGC${e}`,`IC${e}`,`Cr${e}`].includes(i)&&(t[0].push(`${a.name}(${i})`),t[1].push(a.name),n.push(i))}1<=parseInt(e)<=7840&&!n.includes(`NGC${e}`)&&linkExist(`NGC${e}`)&&(t[0].push(`NGC${e}`),t[1].push(`NGC${e}`)),1<=parseInt(e)<=5386&&!n.includes(`IC${e}`)&&linkExist(`IC${e}`)&&(t[0].push(`IC${e}`),t[1].push(`IC${e}`))}}else{if(t=[[],[]],a=[[],[]],isNaN(e)&&!["M","N","I"].includes(e))for(i=0;i<89;i++)(toUpperCaseOrKatakana(constellations[i].JPNname)+"座").includes(e)&&(toUpperCaseOrKatakana(constellations[i].JPNname+"座").startsWith(e)?(t[0].push(`${constellations[i].JPNname}座`),t[1].push(`${constellations[i].JPNname}座`)):(a[0].push(`${constellations[i].JPNname}座`),a[1].push(`${constellations[i].JPNname}座`)));if(!isNaN(e)&&1<=parseInt(e)<=110&&linkExist(`M${e}`)&&(t[0].push(`M${e}`),t[1].push(`M${e}`)),"M"==e[0]&&!isNaN(e.substr(1))&&1<=parseInt(e.substr(1))<=110&&linkExist(e)&&(t[0].push(e.toUpperCase()),t[1].push(e.toUpperCase())),isNaN(e))for(let n of recs){toUpperCaseOrKatakana(n.name).startsWith(e)?(t[0].push(n.name),t[1].push(n.name)):toUpperCaseOrKatakana(n.name).includes(e)&&(a[0].push(n.name),a[1].push(n.name));for(let i of n.alt_name)toUpperCaseOrKatakana(i).startsWith(e)?(t[0].push(n.name),t[1].push(n.name)):toUpperCaseOrKatakana(i).includes(e)&&(a[0].push(n.name),a[1].push(n.name))}else for(let a of recs){[`NGC${e}`,`IC${e}`,`Cr${e}`].includes(a.name)&&(t[0].push(a.name),t[1].push(a.name),n.push(a.name));for(let i of a.alt_name)[`NGC${e}`,`IC${e}`,`Cr${e}`].includes(i)&&(t[0].push(a.name),t[1].push(a.name),n.push(i))}if(isNaN(e)?e.startsWith("NGC")&&!n.includes(e)&&!isNaN(e.substr(3))&&1<=parseInt(e.substr(3))<=7840&&linkExist(e)?(t[0].push(e),t[1].push(e)):e.startsWith("IC")&&!n.includes(e)&&!isNaN(e.substr(2))&&1<=parseInt(e.substr(2))<=5386&&linkExist(e)&&(t[0].push(e),t[1].push(e)):(1<=parseInt(e)<=7840&&!n.includes(`NGC${e}`)&&linkExist(`NGC${e}`)&&(t[0].push(`NGC${e}`),t[1].push(`NGC${e}`)),1<=parseInt(e)<=5386&&!n.includes(`IC${e}`)&&linkExist(`IC${e}`)&&(t[0].push(`IC${e}`),t[1].push(`IC${e}`))),isNaN(e)&&!["M","N","I"].includes(e[0]))for(m of messier)for(alt of m.alt_name)toUpperCaseOrKatakana(alt).includes(e)&&(toUpperCaseOrKatakana(alt).startsWith(e)?(t[0].push(m.name),t[1].push(m.name)):(a[0].push(m.name),a[1].push(m.name)))}document.getElementById("suggestionButtonContainer").innerHTML="";for(let e=0;e<t[0].length;e++){const a=document.createElement("button");a.className="suggestionButton",a.textContent=t[0][e],a.addEventListener("click",function(){link(t[1][e]),document.getElementById("searchInput").value="",closeSearch()}),document.getElementById("suggestionButtonContainer").appendChild(a)}for(let e=0;e<a[0].length;e++){const t=document.createElement("button");t.className="suggestionButton",t.textContent=a[0][e],t.addEventListener("click",function(){link(a[1][e]),document.getElementById("searchInput").value="",closeSearch()}),document.getElementById("suggestionButtonContainer").appendChild(t)}});let trackPlanet="";const trackTimeCheckboxes=document.querySelectorAll(".planet-track-time-checkbox");let timeSliderValue=0,date=new Date;const localDate=new Date(date-6e4*date.getTimezoneOffset());let startX,startY,preX,preY,moveX,moveY;localDate.setSeconds(null),localDate.setMilliseconds(null),localDate.toISOString().slice(0,-1),document.getElementById("dtl").value=localDate.toISOString().slice(0,-1),document.getElementById("dtl").addEventListener("change",ondtlchange),yearTextElem.addEventListener("input",realtimeOff),monthTextElem.addEventListener("input",realtimeOff),dateTextElem.addEventListener("input",realtimeOff),hourTextElem.addEventListener("input",realtimeOff),minuteTextElem.addEventListener("input",realtimeOff),document.querySelectorAll('input[name="realtime"]').forEach(e=>{e.addEventListener("change",e=>{"off"!=e.target.value&&now()})}),aovSliderElem.addEventListener("input",function(){show_main()}),timeSliderElem.addEventListener("input",function(){showingJD+=(timeSliderElem.value-timeSliderValue)/1440,timeSliderValue=timeSliderElem.value;let[e,t,a,n,i]=JD_to_YMDHM(showingJD);setYMDHM(e,t,a,n,i),realtimeOff(),calculation(showingJD),show_main()});let dist_detect=Math.round(canvas.width/200),baseDistance=0,movedDistance=0,distance=0,pinchFlag=!1,dragFlag=!1;document.addEventListener("DOMContentLoaded",function(){loadFiles(),checkURL()}),document.getElementById("copyButton").addEventListener("click",function(){const e=document.getElementById("bookmarkUrl").innerText;navigator.clipboard.writeText(e).then(function(){const e=document.getElementById("copyMessage");e.classList.add("show"),setTimeout(function(){e.classList.remove("show")},2e3)},function(e){console.error("URLのコピーに失敗しました",e)})}),document.getElementById("planetTrackCheck").addEventListener("input",()=>{document.getElementById("planetTrackCheck").checked?document.getElementById("planetTrackTimeCheck").disabled=!1:document.getElementById("planetTrackTimeCheck").disabled=!0}),document.body.appendChild(canvas);